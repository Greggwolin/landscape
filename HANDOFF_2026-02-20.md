# Handoff Summary — 2026-02-20 Session

## What Got Done This Session

### 1. Lease Date Display Fixed
- **Problem**: Rent roll grid showed blank lease dates for most units
- **Root cause**: Grid read from `tbl_multifamily_lease` (only 34 of 102 had dates), not `tbl_multifamily_unit` (102 had dates)
- **Fix**: Backfilled lease dates from unit table → lease table (102 start dates, 100 end dates now in both)
- **Date format**: Changed from "Sep 1, 2025" to "Sep-25" (MMM-YY) in `PropertyTab.tsx` via `formatLeaseDate()` helper
- **File**: `src/app/projects/[projectId]/components/tabs/PropertyTab.tsx` lines 786-787 (fallback), ~1021/1033 (display), helper before `renderRentRollContent`
- **IMPORTANT**: The orphan file `src/app/projects/[projectId]/components/property/RentRoll.tsx` was deleted — it was never rendered and caused hours of misdirected edits

### 2. Market Rent Populated via Landscaper
- Landscaper successfully read OM (doc 58) and updated market_rent for 100 of 113 units
- Remaining 12 units (231-236, 331-336) were manually filled by matching to building 4 counterparts
- Unit 102 (leasing office) correctly at $0
- **Final state**: 112/113 units with market_rent > 0, all values verified correct against OM
- Phantoms (12 units 237-248) were created and deleted
- Bed/bath/current_rent survived on residential units this time (mutation guards partially worked)

### 3. Dynamic Columns (Tags) Wired Up
- **Schema columns removed**: Incorrectly added `tags`/`additional_tags` columns to `tbl_multifamily_unit` — dropped them
- **Dynamic columns system used instead**: Created DynamicColumnDefinition rows (IDs 14, 15) for "Tags" and "Additional Tags"
- **Values populated**: 113 tags, 24 additional_tags from Excel rent roll
- **Deactivated junk**: Old dynamic column defs (IDs 1-12) set to `is_active=false`
- **API param fix**: `backend/apps/dynamic/views.py` lines 46 and 73 — changed to accept both `table_name` and `table` params
- **API URL fix**: `PropertyTab.tsx` line 412 — changed from `/api/dynamic-columns/` to `/api/projects/${projectId}/dynamic/columns/`
- **Always-load fix**: Removed `hasPending` guard so dynamic columns load for all MF projects (not just when pending extraction)
- **Tags now display in grid** — confirmed via browser screenshot

## Pending CC Prompts (Not Yet Applied)

### CC Prompt: Dynamic Columns in Modal + Resizable Columns

File: `src/app/projects/[projectId]/components/tabs/PropertyTab.tsx`

#### Part A: Fix Configure Columns modal showing dynamic columns

**Problem**: `dynamicColumnDefs` at line 382 is hardcoded to `[]`, so dynamic columns never appear in the modal. The merge effect (lines 493-525) that adds them to `columns` state never fires.

**Change A1 — Line 382**: Replace:
```typescript
const dynamicColumnDefs: any[] = [];
```
With:
```typescript
const [dynamicColumnDefs, setDynamicColumnDefs] = useState<any[]>([]);
```

**Change A2** — In the `.then(data => {` handler (around line 414-436), after the `filtered` array is built (after line 426), add:
```typescript
setDynamicColumnDefs(filtered);
```
Keep the existing `setActiveDynCols(...)` call too — it's used for rendering values.

**Change A3 — Line 869**: Remove `activeDynCols` from `visibleColumns`:
Replace:
```typescript
return [...baseCols, ...pendingExtraColumns, ...activeDynCols];
```
With:
```typescript
return [...baseCols, ...pendingExtraColumns];
```

#### Part B: Resizable column widths

Add drag-to-resize handles on every column header.

**Change B1** — Add state near line 372:
```typescript
const [columnWidths, setColumnWidths] = useState<Record<string, number>>({});
const resizingRef = useRef<{ colId: string; startX: number; startWidth: number } | null>(null);
```

**Change B2** — Add resize handler:
```typescript
const handleResizeStart = useCallback((e: React.MouseEvent, colId: string) => {
  e.preventDefault();
  e.stopPropagation();
  const th = (e.target as HTMLElement).closest('th');
  const startWidth = th?.getBoundingClientRect().width || 100;
  resizingRef.current = { colId, startX: e.clientX, startWidth };
  const handleMouseMove = (moveEvent: MouseEvent) => {
    if (!resizingRef.current) return;
    const diff = moveEvent.clientX - resizingRef.current.startX;
    const newWidth = Math.max(40, resizingRef.current.startWidth + diff);
    setColumnWidths(prev => ({ ...prev, [resizingRef.current!.colId]: newWidth }));
  };
  const handleMouseUp = () => {
    resizingRef.current = null;
    document.removeEventListener('mousemove', handleMouseMove);
    document.removeEventListener('mouseup', handleMouseUp);
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  };
  document.addEventListener('mousemove', handleMouseMove);
  document.addEventListener('mouseup', handleMouseUp);
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
}, []);
```

**Change B3** — On `<table>`, add `style={{ tableLayout: 'fixed' }}`. On each `<th>`, add:
- `style={{ width: columnWidths[col.id] ? columnWidths[col.id] + 'px' : 'auto', position: 'relative' }}`
- Inside each `<th>`, after content, add resize handle:
```tsx
<div
  onMouseDown={(e) => handleResizeStart(e, col.id)}
  style={{ position: 'absolute', right: 0, top: 0, bottom: 0, width: '4px', cursor: 'col-resize', backgroundColor: 'transparent' }}
  onMouseOver={(e) => (e.currentTarget.style.backgroundColor = 'var(--cui-primary)')}
  onMouseOut={(e) => (e.currentTarget.style.backgroundColor = 'transparent')}
/>
```

## Per-Tab Landscaper Architecture (Implemented Across Prior + Current Sessions)

### Goal
Each folder/tab combination gets its own independent Landscaper thread rather than sharing one per project. This prevents context pollution, limits thread length (which causes hallucination), and creates a per-tab activity history.

### How It Works
- Thread lookup uses a **3-tuple**: `(project_id, page_context, subtab_context)`
  - `page_context` = the folder (e.g., "property", "operations", "map")
  - `subtab_context` = the tab within the folder (e.g., "rent-roll", "details", "overview")
- When a user opens a tab's Landscaper, it finds or creates a thread matching that tuple
- The **"+" new chat button** in the Landscaper header:
  1. Closes the current thread (`is_active = false`)
  2. Archives it to the Activity Log as an `ActivityItem`
  3. Opens a fresh thread for the same tab
- The Landscaper pill label shows context like "Property · Rent Roll" (with dedup guard to avoid "Rent Roll · Rent Roll")

### DB Schema
- `landscaper_chat_thread` table already had `subtab_context` column — we started using it
- `landscaper_thread_message` links messages to threads via `thread_id`
- Thread naming uses **hyphens** (matching URL params): `rent-roll`, not `rent_roll`

### Files Modified (Prior Session)

**Backend:**
- `backend/apps/landscaper/services/thread_service.py`
  - `get_or_create_active_thread()` — filters by `subtab_context` (or `__isnull` for legacy threads)
  - `start_new_thread()` — scopes closure to matching subtab_context + creates `ActivityItem` archive
  - `get_threads_for_project()` — accepts optional `subtab_context` filter

- `backend/apps/landscaper/views.py`
  - `ChatThreadViewSet.get_queryset()` — filters by `subtab_context` query param

**Frontend:**
- `src/app/projects/[projectId]/ProjectLayoutClient.tsx`
  - Passes `pageContext={currentFolder}` and `subtabContext={currentTab}` to `LandscaperPanel`

- `src/components/landscaper/LandscaperPanel.tsx`
  - Added `subtabContext` to props, passes through to `LandscaperChatThreaded`

- `src/components/landscaper/LandscaperChatThreaded.tsx`
  - Pill label dedup logic (IIFE that checks case-insensitive equality before concatenating)
  - Shortened folder hints (e.g., "Property Details & Site" → "Property")
  - "+" new chat button: calls `startNewThread` + invalidates `landscaper-activities` query cache
  - Uses `cilPlus` icon from CoreUI

- `src/hooks/useLandscaperThreads.ts`
  - `loadThreads` includes `subtab_context` in API query params
  - `useEffect` deps include `subtabContext`

### Known Issues
- Old threads with `subtab_context = NULL` may still exist — these are legacy pre-tab threads
- Thread naming must use hyphens (URL format) not underscores — inconsistency caused duplicate threads earlier
- Activity feed refresh requires `queryClient.invalidateQueries({ queryKey: ['landscaper-activities'] })` after new thread creation (60s refetchInterval + 30s staleTime otherwise)

### Thread Poisoning Risk
Long threads with incorrect Landscaper responses reinforce hallucination patterns. Claude learns to "role-play" tool use from its own history. The new chat button is the primary mitigation — archive the bad thread and start fresh. The hallucination detection+retry mechanism in `ai_handler.py` is a secondary defense.

## Hallucination Detection + Retry

### Problem
The Landscaper AI generates text mimicking tool results (e.g., "Done. Updated all 113 units" with fake batch descriptions) instead of making actual `tool_use` API calls. DB confirms `tool_executions: []` and `stop_reason: end_turn`.

### Implementation
- **File**: `backend/apps/landscaper/ai_handler.py` lines 6447-6494
- **How**: After each API response, if `stop_reason == "end_turn"` and `tool_executor` exists, scan the response text for mutation claim patterns:
  - "updated N units", "Batch 1: Updated...", "[Tool calls executed..."
- If detected, append a correction message forcing Claude to use actual `tool_use` mechanism, and retry the API call
- **System prompt reinforcement**: Lines 5464-5503 — sections on MUTATION EXECUTION REQUIREMENTS, TOOL USE FORMAT, PARTIAL UPDATES, POST-MUTATION VERIFICATION

### Status
- Mechanism is implemented but **partially effective** — the Landscaper used real tool calls on the last test (market_rent values landed in DB), but still created phantom units
- May need additional iteration on system prompt wording and retry logic

## Mutation Service Guards (Partially Working)

### Problem
When the Landscaper updates units, it can: (a) create phantom units that don't exist, (b) overwrite bed/bath/rent with wrong defaults, (c) wipe lease dates

### Implementation
- **File**: `backend/apps/landscaper/services/mutation_service.py`
- **Update-only guard** (~line 1246): When >50% of specified units already exist, skip non-existent unit numbers (prevents phantoms)
- **Robust partial detection** (~line 1192): Always pre-loads existing data; detects suspicious defaults (bedrooms=0 when existing has 3, bathrooms=1 when existing has 2)
- **Lease date preservation** (~line 1340): Fetches existing lease dates and fills nulls

### Status
- Bed/bath/current_rent survived the last test (guard worked for field preservation)
- **Phantom prevention still fails** — 12 phantom units were created despite the >50% guard. Needs to be changed to strict UPDATE-only mode (no INSERT) when the operation is a single-field update on existing records

## Still Outstanding

1. **Landscaper hallucination issue**: Detection+retry added to `ai_handler.py` but the Landscaper still creates phantom units. Mutation service needs strict UPDATE-only mode (no INSERT) for single-field updates.
2. **Market rent via Landscaper end-to-end**: Works partially (100/113 units), but creates phantoms. Need to fix mutation guard before re-testing.
3. **Hallucination detection testing**: Mechanism in `ai_handler.py:6447-6494` — untested whether it actually triggers retries.

## Current DB State (Project 17 — Chadron Terrace Garden)
- 113 units, correct bed/bath/sqft/current_rent
- 112/113 with market_rent (102 = $0 leasing office)
- 102 lease start dates, 100 lease end dates (in BOTH unit and lease tables)
- Dynamic columns: Tags (ID 14, 113 values), Additional Tags (ID 15, 24 values)
- Junk dynamic column defs (IDs 1-12) deactivated

## Key Files Modified This Session
- `src/app/projects/[projectId]/components/tabs/PropertyTab.tsx` — lease date fallback, MMM-YY format, dynamic columns always-load, API URL fix
- `backend/apps/dynamic/views.py` — table_name param fix (lines 46, 73)
- `src/app/projects/[projectId]/components/property/RentRoll.tsx` — DELETED (orphan)
