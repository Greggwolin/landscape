# GitHub Actions: Production Deployment
# Version: v1.0 (2025-10-13)
#
# Triggers on push to main branch
# - Runs full test suite
# - Creates production snapshot
# - Runs migrations on production
# - Deploys to Vercel production
# - Performs health checks

name: Production Deployment

on:
  push:
    branches:
      - main

env:
  NODE_VERSION: '20'
  NEON_PROJECT_ID: ${{ secrets.NEON_PROJECT_ID }}
  NEON_API_KEY: ${{ secrets.NEON_API_KEY }}

jobs:
  # ==========================================================================
  # JOB 1: Pre-deployment Tests
  # ==========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Lint
        run: |
          npm run lint
          npm run typecheck

      - name: Build
        run: npm run build
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run unit tests
        run: npm test -- --coverage --maxWorkers=2
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: production

  # ==========================================================================
  # JOB 2: Create Database Snapshot
  # ==========================================================================
  snapshot-database:
    name: Create Database Snapshot
    runs-on: ubuntu-latest
    needs: test
    outputs:
      snapshot_id: ${{ steps.snapshot.outputs.snapshot_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Neon CLI
        run: npm install -g neonctl

      - name: Create snapshot
        id: snapshot
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SNAPSHOT_NAME="pre-deploy-${TIMESTAMP}-${{ github.sha }}"

          echo "Creating snapshot: $SNAPSHOT_NAME"

          # Create branch as snapshot (Neon doesn't have direct snapshots, use branches)
          SNAPSHOT_RESPONSE=$(neonctl branches create \
            --project-id "$NEON_PROJECT_ID" \
            --name "$SNAPSHOT_NAME" \
            --parent main \
            --output json)

          SNAPSHOT_ID=$(echo "$SNAPSHOT_RESPONSE" | jq -r '.id')
          echo "snapshot_id=$SNAPSHOT_ID" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Snapshot created: $SNAPSHOT_ID"

      - name: Comment commit
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `üì∏ **Database Snapshot Created**

              Snapshot ID: \`${{ steps.snapshot.outputs.snapshot_id }}\`

              This snapshot can be used for rollback if needed.
              Retention: 7 days`
            })

  # ==========================================================================
  # JOB 3: Run Production Migrations
  # ==========================================================================
  migrate-production:
    name: Run Production Migrations
    runs-on: ubuntu-latest
    needs: [test, snapshot-database]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Install Neon CLI
        run: npm install -g neonctl

      - name: Run migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          chmod +x ./scripts/run-migrations.sh
          ./scripts/run-migrations.sh main

      - name: Verify migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Verifying migration status..."
          psql "$DATABASE_URL" -c "SELECT migration_file, applied_at FROM landscape._migrations ORDER BY migration_id DESC LIMIT 10"

  # ==========================================================================
  # JOB 4: Deploy to Production
  # ==========================================================================
  deploy-production:
    name: Deploy to Vercel Production
    runs-on: ubuntu-latest
    needs: [test, snapshot-database, migrate-production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        id: vercel-deploy
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: Wait for deployment
        run: sleep 30

  # ==========================================================================
  # JOB 5: Health Checks
  # ==========================================================================
  health-check:
    name: Production Health Check
    runs-on: ubuntu-latest
    needs: deploy-production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check API health
        run: |
          echo "Checking production health endpoint..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://landscape.5150east.com/api/health || echo "000")

          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Health check passed (HTTP $RESPONSE)"
          else
            echo "‚ùå Health check failed (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Run smoke tests
        run: |
          echo "Running production smoke tests..."
          # Add smoke test commands here

      - name: Notify success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `‚úÖ **Production Deployment Successful**

              - Migrations: Applied
              - Deployment: Complete
              - Health Check: Passed
              - Snapshot: \`${{ needs.snapshot-database.outputs.snapshot_id }}\`

              Production is live and healthy!`
            })

      - name: Notify failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `‚ùå **Production Deployment Failed**

              Health checks did not pass. Please investigate immediately.

              Rollback instructions:
              1. Use snapshot: \`${{ needs.snapshot-database.outputs.snapshot_id }}\`
              2. Run: \`./scripts/rollback-production.sh ${{ needs.snapshot-database.outputs.snapshot_id }}\`

              @oncall-eng`
            })
