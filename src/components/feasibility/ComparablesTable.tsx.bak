'use client';

import React, { useState } from 'react';
import { CButton, CTable, CTableHead, CTableRow, CTableHeaderCell, CTableBody, CTableDataCell } from '@coreui/react';
import CIcon from '@coreui/icons-react';
import { cilPencil, cilTrash, cilPlus } from '@coreui/icons';

export interface ComparableColumn {
  key: string;
  label: string;
  type: 'text' | 'number' | 'date' | 'currency';
  width?: string;
}

export interface ComparableRow {
  id: number;
  [key: string]: any;
}

interface ComparablesTableProps {
  title: string;
  columns: ComparableColumn[];
  data: ComparableRow[];
  onAdd: () => void;
  onEdit: (row: ComparableRow) => void;
  onDelete: (id: number) => void;
  emptyMessage?: string;
}

/**
 * ComparablesTable Component
 *
 * Reusable table for Market Data comparables:
 * - Comparable Land Sales
 * - Housing Price Comparables
 * - Absorption Rate Comparables
 *
 * Features:
 * - Add/Edit/Delete actions
 * - Formatted columns (currency, date, number)
 * - Empty state message
 */
export default function ComparablesTable({
  title,
  columns,
  data,
  onAdd,
  onEdit,
  onDelete,
  emptyMessage = 'No data available. Click "Add Comparable" to get started.',
}: ComparablesTableProps) {
  const [deletingId, setDeletingId] = useState<number | null>(null);

  const formatValue = (value: any, type: ComparableColumn['type']): string => {
    if (value === null || value === undefined) return 'â€”';

    switch (type) {
      case 'currency':
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        }).format(value);
      case 'number':
        return new Intl.NumberFormat('en-US').format(value);
      case 'date':
        return new Date(value).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
        });
      case 'text':
      default:
        return String(value);
    }
  };

  const handleDelete = (id: number) => {
    setDeletingId(id);
    onDelete(id);
    // Reset after a short delay
    setTimeout(() => setDeletingId(null), 500);
  };

  return (
    <div
      className="comparables-table-container"
      style={{
        background: 'var(--cui-card-bg)',
        border: '1px solid var(--cui-border-color)',
        borderRadius: '0.375rem',
      }}
    >
      {/* Header */}
      <div
        className="d-flex tw-justify-content-between tw-align-items-center p-3"
        style={{ borderBottom: '1px solid var(--cui-border-color)' }}
      >
        <h5 className="mb-0" style={{ color: 'var(--cui-body-color)' }}>
          {title}
        </h5>
        <CButton
          color="primary"
          size="sm"
          onClick={onAdd}
          aria-label={`Add ${title}`}
        >
          <CIcon icon={cilPlus} className="me-1" />
          Add Comparable
        </CButton>
      </div>

      {/* Table */}
      <div className="p-3">
        {data.length === 0 ? (
          <div
            className="text-center py-5"
            style={{ color: 'var(--cui-secondary-color)' }}
          >
            {emptyMessage}
          </div>
        ) : (
          <CTable hover responsive>
            <CTableHead>
              <CTableRow>
                {columns.map((col) => (
                  <CTableHeaderCell
                    key={col.key}
                    style={{ width: col.width }}
                  >
                    {col.label}
                  </CTableHeaderCell>
                ))}
                <CTableHeaderCell style={{ width: '120px' }}>
                  Actions
                </CTableHeaderCell>
              </CTableRow>
            </CTableHead>
            <CTableBody>
              {data.map((row) => (
                <CTableRow
                  key={row.id}
                  style={{
                    opacity: deletingId === row.id ? 0.5 : 1,
                    transition: 'opacity 0.3s',
                  }}
                >
                  {columns.map((col) => (
                    <CTableDataCell key={col.key}>
                      {formatValue(row[col.key], col.type)}
                    </CTableDataCell>
                  ))}
                  <CTableDataCell>
                    <div className="d-flex gap-2">
                      <CButton
                        color="ghost-secondary"
                        size="sm"
                        onClick={() => onEdit(row)}
                        aria-label="Edit comparable"
                      >
                        <CIcon icon={cilPencil} />
                      </CButton>
                      <CButton
                        color="ghost-danger"
                        size="sm"
                        onClick={() => handleDelete(row.id)}
                        disabled={deletingId === row.id}
                        aria-label="Delete comparable"
                      >
                        <CIcon icon={cilTrash} />
                      </CButton>
                    </div>
                  </CTableDataCell>
                </CTableRow>
              ))}
            </CTableBody>
          </CTable>
        )}
      </div>
    </div>
  );
}
