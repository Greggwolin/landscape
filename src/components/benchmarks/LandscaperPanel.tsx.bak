/**
 * Landscaper Assistant Panel
 * Shows AI chat, suggestions, insights, and recent activity
 */

import React, { useState, useRef, useEffect } from 'react';
import { TrendingUp, CheckCircle, Info, Send, MessageSquare } from 'lucide-react';
import type { BenchmarkCategory, AISuggestion } from '@/types/benchmarks';
import AISuggestionsSection from './AISuggestionsSection';
import { useLandscaperThreads } from '@/hooks/useLandscaperThreads';
import { processLandscaperResponse } from '@/utils/formatLandscaperResponse';

interface Props {
  selectedCategory: BenchmarkCategory | null;
  aiSuggestions: AISuggestion[];
  onRefresh: () => void;
}

export default function LandscaperPanel({
  selectedCategory,
  aiSuggestions,
  onRefresh
}: Props) {
  return (
    <div className="p-6 tw-space-y-6">
      {/* Context Header */}
      {selectedCategory && (
        <div className="pb-4 tw-border-b border-line-strong">
          <h2 className="tw-text-lg tw-font-bold">{selectedCategory.label}</h2>
          <p className="tw-text-sm text-text-secondary">
            {aiSuggestions.length} pending suggestion{aiSuggestions.length !== 1 ? 's' : ''} from recent documents
          </p>
        </div>
      )}

      {/* AI Chat Section */}
      <BenchmarkChatSection />

      {/* AI Suggestions Section */}
      {aiSuggestions.length > 0 ? (
        <AISuggestionsSection
          suggestions={aiSuggestions}
          onRefresh={onRefresh}
        />
      ) : (
        <div className="p-8 text-center text-text-secondary">
          <Info size={48} className="mx-auto mb-3 text-text-secondary" />
          <p>No AI suggestions at this time</p>
          <p className="tw-text-sm mt-2">
            Upload documents to extract benchmarks automatically
          </p>
        </div>
      )}

      {/* Insights Section */}
      <InsightsSection />

      {/* Recent Activity Section */}
      <RecentActivitySection />
    </div>
  );
}

// Benchmark Chat Section - allows users to ask questions about benchmarks
function BenchmarkChatSection() {
  const [input, setInput] = useState('');
  const scrollRef = useRef<HTMLDivElement>(null);

  // Use unified Landscaper API for benchmark context
  const {
    messages,
    isLoading,
    sendMessage,
  } = useLandscaperThreads({
    projectId: '0',
    pageContext: 'benchmarks',
  });

  // Auto-scroll to bottom when messages change
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [messages]);

  const handleSend = async () => {
    const query = input.trim();
    if (!query || isLoading) return;

    setInput('');
    try {
      await sendMessage(query);
    } catch (error) {
      console.error('[BenchmarkChat] Error:', error);
    }
  };

  const suggestedQuestions = [
    "What's typical R&M per unit?",
    "IREM expense ratios for multifamily",
    "How do I validate my expense assumptions?"
  ];

  return (
    <div className="tw-space-y-3 pb-4 tw-border-b border-line-strong">
      <h3 className="tw-text-sm tw-font-semibold tw-flex tw-items-center gap-2">
        <MessageSquare size={16} className="tw-text-blue-500" />
        Ask Landscaper
      </h3>

      {/* Messages */}
      {messages.length > 0 && (
        <div
          ref={scrollRef}
          className="tw-max-h-[200px] tw-overflow-y-auto tw-space-y-2"
        >
          {messages.map((msg, idx) => (
            <div
              key={msg.messageId || idx}
              className={`p-2 rounded tw-text-sm ${ msg.role === 'user' ? tw-'bg-blue-600 text-white ml-8' : 'bg-surface-card border border-line-strong text-text-primary' }`}
              style={{ whiteSpace: 'pre-wrap' }}
            >
              {msg.role === 'assistant' ? processLandscaperResponse(msg.content) : msg.content}
            </div>
          ))}
          {isLoading && (
            <div className="p-2 rounded tw-text-sm bg-surface-card border border-line-strong text-text-secondary">
              Thinking...
            </div>
          )}
        </div>
      )}

      {/* Suggested questions when no messages */}
      {messages.length === 0 && (
        <div className="tw-flex tw-flex-wrap gap-2">
          {suggestedQuestions.map((q, idx) => (
            <button
              key={idx}
              onClick={() => setInput(q)}
              className="tw-text-xs px-2 py-1 rounded border border-line-strong hover:bg-surface-hover text-text-secondary"
            >
              {q}
            </button>
          ))}
        </div>
      )}

      {/* Input */}
      <div className="tw-flex tw-items-center gap-2">
        <input
          type="text"
          placeholder="Ask about benchmarks, IREM data, expenses..."
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              void handleSend();
            }
          }}
          disabled={isLoading}
          className="tw-flex-1 h-8 px-3 tw-text-sm rounded border border-line-strong bg-surface-base text-text-primary placeholder:text-text-secondary"
        />
        <button
          onClick={() => void handleSend()}
          disabled={isLoading || !input.trim()}
          className="h-8 w-8 rounded tw-bg-blue-600 text-white tw-flex tw-items-center tw-justify-center disabled:tw-opacity-50"
        >
          <Send size={14} />
        </button>
      </div>
    </div>
  );
}

// Insights Section
function InsightsSection() {
  // TODO: Replace with actual inflation analysis data
  const insights = [
    { type: 'warning' as const, message: '3 stale benchmarks need review (>24 months old)' },
    { type: 'info' as const, message: 'Grading costs trending +8% over last 6 months' },
    { type: 'info' as const, message: 'Phoenix absorption slowing - consider updating forecasts' },
  ];

  if (insights.length === 0) return null;

  return (
    <div className="tw-space-y-4 pt-4 tw-border-t border-line-strong">
      <h3 className="tw-text-sm tw-font-semibold tw-flex tw-items-center gap-2">
        <TrendingUp size={16} className="text-chip-warning" />
        Insights
      </h3>

      <div className="tw-space-y-2">
        {insights.map((insight, idx) => (
          <div
            key={idx}
            className={`p-3 rounded border tw-text-sm ${ insight.type === 'warning' ? 'bg-chip-warning/15 border-chip-warning text-chip-warning' : 'bg-surface-card border-line-strong text-text-secondary' }`}
          >
            • {insight.message}
          </div>
        ))}
      </div>
    </div>
  );
}

// Recent Activity Section
function RecentActivitySection() {
  // TODO: Replace with actual activity data from API
  const activities = [
    { time: '2h ago', description: 'Grading updated (clay soil variant added)' },
    { time: '1d ago', description: 'Phoenix absorption data refreshed' },
    { time: '3d ago', description: 'Commission structure changed 6% → 5.5%' },
  ];

  if (activities.length === 0) return null;

  return (
    <div className="tw-space-y-4 pt-4 tw-border-t border-line-strong">
      <h3 className="tw-text-sm tw-font-semibold tw-flex tw-items-center gap-2">
        <CheckCircle size={16} className="text-chip-success" />
        Recent Activity
      </h3>

      <div className="tw-space-y-2 tw-text-sm text-text-secondary">
        {activities.map((activity, idx) => (
          <div key={idx} className="tw-flex tw-items-start gap-2">
            <span className="text-text-secondary tw-min-w-[60px]">{activity.time}</span>
            <span>{activity.description}</span>
          </div>
        ))}
      </div>
    </div>
  );
}
