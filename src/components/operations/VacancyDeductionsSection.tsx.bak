'use client';

import React, { useState } from 'react';
import { SectionCard } from './SectionCard';
import { DetailSummaryToggle, ViewMode } from './DetailSummaryToggle';
import { InputCell } from './InputCell';
import { EvidenceCell } from './EvidenceCell';
import { AddButton } from './AddButton';
import { LockClosedIcon } from '@heroicons/react/20/solid';
import { LineItemRow, formatCurrency, formatPercent } from './types';

interface VacancyDeductionsSectionProps {
  rows: LineItemRow[];
  grossPotentialRent: number;
  availableScenarios: string[];
  preferredScenario: string;
  valueAddEnabled: boolean;
  hasDetailedRentRoll?: boolean;
  onUpdateRow: (lineItemKey: string, field: string, value: number | null) => void;
  onAddItem?: () => void;
}

/**
 * VacancyDeductionsSection - Flat table for vacancy and deductions
 *
 * Displays deduction types (Physical Vacancy, Credit Loss, Concessions, etc.)
 * with rate %, amount, and evidence. Shows Net Rental Income subtotal.
 */
export function VacancyDeductionsSection({
  rows,
  grossPotentialRent,
  availableScenarios,
  preferredScenario,
  valueAddEnabled,
  hasDetailedRentRoll = false,
  onUpdateRow,
  onAddItem
}: VacancyDeductionsSectionProps) {
  const [viewMode, setViewMode] = useState<ViewMode>('detail');
  const [evidenceExpanded, setEvidenceExpanded] = useState(false);

  // Calculate totals (all deductions are negative)
  const totals = rows.reduce(
    (acc, row) => ({
      as_is_total: acc.as_is_total + (row.as_is.total || 0),
      post_reno_total: acc.post_reno_total + (row.post_reno?.total || 0)
    }),
    { as_is_total: 0, post_reno_total: 0 }
  );

  // Net Rental Income = GPR - Total Deductions
  const netRentalIncomeAsIs = grossPotentialRent + totals.as_is_total; // totals are negative
  const netRentalIncomePostReno = grossPotentialRent + totals.post_reno_total;

  // Calculate total deduction percentage of GPR
  const totalDeductionPercentAsIs = grossPotentialRent > 0
    ? Math.abs(totals.as_is_total) / grossPotentialRent
    : 0;
  const totalDeductionPercentPostReno = grossPotentialRent > 0
    ? Math.abs(totals.post_reno_total) / grossPotentialRent
    : 0;

  // Determine if there are extra scenarios beyond the preferred one
  const hasExtraScenarios = availableScenarios.length > 1;
  const extraScenarios = availableScenarios.filter(s => s !== preferredScenario);

  const controls = (
    <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
      {onAddItem && <AddButton label="Add" onClick={onAddItem} />}
      <DetailSummaryToggle value={viewMode} onChange={setViewMode} />
    </div>
  );

  return (
    <SectionCard
      title="Vacancy & Deductions"
      controls={controls}
      evidenceExpanded={evidenceExpanded}
    >
      <table className="ops-table">
        <thead>
          <tr>
            <th style={{ width: '18%' }}>Deduction</th>
            <th className="num" style={{ width: '6%' }}>Count</th>
            <th className="num" style={{ width: '9%' }}>Rate</th>
            <th className="num" style={{ width: '7%' }}>—</th>
            <th className="num" style={{ width: '10%' }}>Amount</th>
            <th className="num" style={{ width: '8%' }}>—</th>
            {valueAddEnabled && (
              <>
                <th className="num post-reno" style={{ width: '9%' }}>Post-Reno</th>
                <th className="num post-reno" style={{ width: '10%' }}>Reno Amt</th>
              </>
            )}
            {availableScenarios.length > 0 && (
              <th
                className={`num evidence ops-evidence-group ${evidenceExpanded ? 'expanded' : ''}`}
                style={{ width: '8%' }}
                onClick={() => setEvidenceExpanded(!evidenceExpanded)}
              >
                {preferredScenario.replace('_', ' ')}
                {hasExtraScenarios && <span className="chevron">▶</span>}
              </th>
            )}
            {evidenceExpanded && extraScenarios.map(scenario => (
              <th
                key={scenario}
                className="num evidence ops-evidence-extra"
                style={{ width: '8%' }}
              >
                {scenario.replace('_', ' ')}
              </th>
            ))}
          </tr>
        </thead>
        <tbody>
          {viewMode === 'detail' && rows.map((row) => {
            // Calculate amount from rate if it's a percentage
            const isPercentage = row.is_percentage;
            const asIsAmount = row.as_is.total;
            const postRenoAmount = row.post_reno?.total;
            // Physical vacancy is read-only if calculated from rent roll
            const isReadOnly = row.is_readonly || (row.line_item_key === 'physical_vacancy' && hasDetailedRentRoll);

            return (
              <tr key={row.line_item_key}>
                <td className="tw-flex tw-items-center gap-1">
                  {row.label}
                  {isReadOnly && (
                    <span className="tw-inline-flex tw-items-center gap-1 tw-text-xs tw-text-gray-500 ml-1">
                      <LockClosedIcon className="w-3 h-3" />
                      <span className="tw-hidden sm:tw-inline">Calculated</span>
                    </span>
                  )}
                </td>
                <td className="num">{row.as_is.count ?? '—'}</td>
                <td className="num">
                  {isReadOnly ? (
                    // Read-only display for calculated vacancy
                    <span className="tw-text-sm tw-font-medium">
                      {formatPercent(row.as_is.rate)}
                    </span>
                  ) : (
                    <InputCell
                      value={row.as_is.rate}
                      variant="as-is"
                      format={isPercentage ? 'percent' : 'currency'}
                      onChange={(val) => onUpdateRow(row.line_item_key, 'as_is_rate', val)}
                    />
                  )}
                </td>
                <td className="num">—</td>
                <td className={`num ops-calc ${asIsAmount && asIsAmount < 0 ? 'ops-negative' : ''}`}>
                  {asIsAmount ? `(${formatCurrency(Math.abs(asIsAmount))})` : '—'}
                </td>
                <td className="num">—</td>
                {valueAddEnabled && (
                  <>
                    <td className="num post-reno">
                      <InputCell
                        value={row.post_reno?.rate}
                        variant="post-reno"
                        format={isPercentage ? 'percent' : 'currency'}
                        onChange={(val) => onUpdateRow(row.line_item_key, 'post_reno_rate', val)}
                      />
                    </td>
                    <td className={`num post-reno ops-calc ${postRenoAmount && postRenoAmount < 0 ? 'ops-negative' : ''}`}>
                      {postRenoAmount ? `(${formatCurrency(Math.abs(postRenoAmount))})` : '—'}
                    </td>
                  </>
                )}
                {availableScenarios.length > 0 && (
                  <td className="num evidence ops-evidence-group">
                    <EvidenceCell
                      value={row.evidence[preferredScenario]?.rate}
                      format={isPercentage ? 'percent' : 'currency'}
                    />
                  </td>
                )}
                {evidenceExpanded && extraScenarios.map(scenario => (
                  <td key={scenario} className="num evidence ops-evidence-extra">
                    <EvidenceCell
                      value={row.evidence[scenario]?.rate}
                      format={isPercentage ? 'percent' : 'currency'}
                    />
                  </td>
                ))}
              </tr>
            );
          })}

          {/* Total Deductions Row - only in summary mode */}
          {viewMode === 'summary' && (
            <tr className="ops-subtotal-row">
              <td>Total Vacancy & Deductions</td>
              <td className="num">—</td>
              <td className="num">
                <span className="ops-subtotal-value">{(totalDeductionPercentAsIs * 100).toFixed(1)}%</span>
              </td>
              <td className="num">—</td>
              <td className="num ops-calc ops-negative">({formatCurrency(Math.abs(totals.as_is_total))})</td>
              <td className="num"></td>
              {valueAddEnabled && (
                <>
                  <td className="num post-reno">
                    <span className="ops-subtotal-value">{(totalDeductionPercentPostReno * 100).toFixed(1)}%</span>
                  </td>
                  <td className="num post-reno ops-calc ops-negative">({formatCurrency(Math.abs(totals.post_reno_total))})</td>
                </>
              )}
              {availableScenarios.length > 0 && (
                <td className="num evidence ops-evidence-group">—</td>
              )}
              {evidenceExpanded && extraScenarios.map(scenario => (
                <td key={scenario} className="num evidence ops-evidence-extra">—</td>
              ))}
            </tr>
          )}

          {/* Net Rental Income Subtotal Row - always visible */}
          <tr className="ops-subtotal-row">
            <td>Net Rental Income</td>
            <td className="num"></td>
            <td className="num"></td>
            <td className="num"></td>
            <td className="num ops-calc">{formatCurrency(netRentalIncomeAsIs)}</td>
            <td className="num"></td>
            {valueAddEnabled && (
              <>
                <td className="num post-reno"></td>
                <td className="num post-reno ops-calc">{formatCurrency(netRentalIncomePostReno)}</td>
              </>
            )}
            {availableScenarios.length > 0 && (
              <td className="num evidence ops-evidence-group"></td>
            )}
            {evidenceExpanded && extraScenarios.map(scenario => (
              <td key={scenario} className="num evidence ops-evidence-extra"></td>
            ))}
          </tr>
        </tbody>
      </table>
    </SectionCard>
  );
}

export default VacancyDeductionsSection;
