'use client';

import React, { useCallback, useMemo, useState } from 'react';
import CIcon from '@coreui/icons-react';
import { cilLayers } from '@coreui/icons';
import { useDropzone } from 'react-dropzone';
import type { DMSDocument } from '@/types/dms';
import { useUploadStaging } from '@/contexts/UploadStagingContext';
import MediaBadgeChips from '@/components/dms/MediaBadgeChips';

export interface FilterAccordion {
  doc_type: string;
  icon: string;
  count: number;
  is_expanded: boolean;
  documents?: DMSDocument[];
  is_from_template?: boolean;
  custom_id?: number; // dms_project_doc_types.id for custom types
}

import styles from './AccordionFilters.module.css';

interface AccordionFiltersProps {
  filters: FilterAccordion[];
  onExpand: (docType: string) => void;
  onFilterClick?: (docType: string) => void; // Optional - kept for backwards compatibility
  onDocumentSelect: (doc: DMSDocument) => void;
  expandedFilter?: string | null;
  activeFilter?: string | null;
  selectedDocIds?: Set<string>;
  onToggleDocSelection?: (docId: string) => void;
  onReviewMedia?: (docId: number, docName: string) => void;
  onDeleteFilter?: (customId: number, docTypeName: string) => void;
  onLinkVersion?: (sourceDocId: string, targetDoc: DMSDocument) => void;
}

const acceptedFileTypes = {
  'application/pdf': ['.pdf'],
  'application/msword': ['.doc'],
  'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
  'application/vnd.ms-excel': ['.xls'],
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
  'image/jpeg': ['.jpg', '.jpeg'],
  'image/png': ['.png'],
  'image/gif': ['.gif'],
  'text/plain': ['.txt'],
  'text/csv': ['.csv']
};

interface FilterDropRowProps {
  filter: FilterAccordion;
  expandedFilter?: string | null;
  onExpand: (docType: string) => void;
  onDocumentSelect: (doc: DMSDocument) => void;
  selectedDocIds?: Set<string>;
  onToggleDocSelection?: (docId: string) => void;
  onReviewMedia?: (docId: number, docName: string) => void;
  onDeleteFilter?: (customId: number, docTypeName: string) => void;
  onLinkVersion?: (sourceDocId: string, targetDoc: DMSDocument) => void;
}

function FilterDropRow({
  filter,
  expandedFilter,
  onExpand,
  onDocumentSelect,
  selectedDocIds,
  onToggleDocSelection,
  onReviewMedia,
  onDeleteFilter,
  onLinkVersion
}: FilterDropRowProps) {
  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
  const [dropTargetDocId, setDropTargetDocId] = useState<string | null>(null);

  const { stageFiles } = useUploadStaging();

  const onDrop = useCallback(
    (acceptedFiles: File[]) => {
      if (acceptedFiles.length === 0) return;
      stageFiles(acceptedFiles, { suggestedDocType: filter.doc_type });
    },
    [stageFiles, filter.doc_type]
  );

  const {
    getRootProps,
    isDragActive,
    isDragReject
  } = useDropzone({
    onDrop,
    accept: acceptedFileTypes,
    maxSize: 32 * 1024 * 1024,
    maxFiles: 10,
    noClick: true,
    noKeyboard: true,
  });

  const isExpanded = expandedFilter === filter.doc_type;
  const headerDynamicStyle: React.CSSProperties = {
    backgroundColor: isExpanded ? 'var(--cui-primary-bg)' : 'var(--cui-body-bg)',
    borderBottomColor: isExpanded ? 'var(--cui-primary)' : 'var(--cui-border-color)',
    color: 'var(--cui-body-color)'
  };
  const mutedTextStyle: React.CSSProperties = {
    color: 'var(--cui-secondary-color)'
  };
  const nameStyle: React.CSSProperties = isExpanded
    ? {
        color: 'var(--cui-primary)',
        fontWeight: 600
      }
    : { color: 'var(--cui-body-color)' };

  const dropStateClass = isDragActive
    ? (isDragReject ? styles.filterRowReject : styles.filterRowActive)
    : '';

  return (
    <div key={filter.doc_type} style={{ backgroundColor: 'var(--cui-body-bg)' }}>
      <div
        {...getRootProps()}
        className={`group tw-flex tw-items-center gap-1.5 px-3 py-1.25 tw-transition-colors ${styles.filterRow} ${dropStateClass}`}
        style={{
          ...headerDynamicStyle,
          borderBottomWidth: '1px',
          borderBottomStyle: 'solid',
          borderBottomColor: headerDynamicStyle.borderBottomColor ?? 'var(--cui-border-color)'
        }}
        data-doc-type={filter.doc_type}
      >
        <button
          onClick={() => onExpand(filter.doc_type)}
          className="w-4 tw-flex-shrink-0 tw-transition-colors"
          style={mutedTextStyle}
          aria-label={isExpanded ? 'Collapse' : 'Expand'}
        >
          {isExpanded ? 'â–¾' : 'â–¸'}
        </button>

        <button
          onClick={() => onExpand(filter.doc_type)}
          className={`${styles.filterIconButton} ${isExpanded ? styles.filterIconButtonActive : ''}`}
          aria-label={`${isExpanded ? 'Collapse' : 'Expand'} ${filter.doc_type}`}
        >
          <CIcon icon={cilLayers} className="w-5 h-5" />
        </button>

        <button
          onClick={() => onExpand(filter.doc_type)}
          className={`${styles.filterNameButton} ${isExpanded ? styles.filterNameButtonActive : ''}`}
          style={nameStyle}
          aria-expanded={isExpanded}
        >
          {filter.doc_type}
        </button>

        <span className="tw-text-sm" style={mutedTextStyle}>
          ~{filter.count}
        </span>

        <button className="tw-text-sm hover:underline" style={{ color: 'var(--cui-body-color)' }}>
          Edit
        </button>

        {/* Delete button for custom (non-template) types */}
        {filter.is_from_template === false && filter.custom_id && onDeleteFilter && (
          <div className="tw-relative" style={{ marginLeft: '2px' }}>
            {showDeleteConfirm ? (
              <div
                className="tw-absolute right-0 top-full tw-z-50 mt-1 p-2 rounded tw-shadow-lg border tw-text-xs"
                style={{
                  backgroundColor: 'var(--cui-body-bg)',
                  borderColor: 'var(--cui-border-color)',
                  minWidth: '200px',
                  whiteSpace: 'nowrap'
                }}
              >
                <p className="mb-2" style={{ color: 'var(--cui-body-color)' }}>
                  Remove &lsquo;{filter.doc_type}&rsquo;?<br />
                  <span style={{ color: 'var(--cui-secondary-color)' }}>
                    Documents move to Misc.
                  </span>
                </p>
                <div className="tw-flex gap-2">
                  <button
                    className="px-2 py-0.5 rounded text-white"
                    style={{ backgroundColor: 'var(--cui-danger)', fontSize: '0.7rem' }}
                    onClick={(e) => {
                      e.stopPropagation();
                      onDeleteFilter(filter.custom_id!, filter.doc_type);
                      setShowDeleteConfirm(false);
                    }}
                  >
                    Remove
                  </button>
                  <button
                    className="px-2 py-0.5 rounded border"
                    style={{
                      borderColor: 'var(--cui-border-color)',
                      color: 'var(--cui-body-color)',
                      fontSize: '0.7rem'
                    }}
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowDeleteConfirm(false);
                    }}
                  >
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              <button
                className={`styles.filterDeleteButton`}
                style={{
                  color: 'var(--cui-secondary-color)',
                  fontSize: '0.9rem',
                  lineHeight: 1,
                  padding: '2px 4px',
                  borderRadius: '3px'
                }}
                onClick={(e) => {
                  e.stopPropagation();
                  setShowDeleteConfirm(true);
                }}
                title={`Remove "${filter.doc_type}"`}
              >
                Ã—
              </button>
            )}
          </div>
        )}
      </div>

      {isExpanded && (
        <div
          className="px-4 py-2 tw-space-y-1 tw-border-t"
          style={{
            backgroundColor: 'var(--cui-tertiary-bg)',
            borderColor: 'var(--cui-border-color)'
          }}
        >
          {!filter.documents || filter.documents.length === 0 ? (
            <div className="tw-text-sm italic py-2" style={mutedTextStyle}>
              {filter.count === 0 ? 'No documents' : 'Loading...'}
            </div>
          ) : (
            filter.documents.map((doc) => (
              <div
                key={doc.doc_id}
                className="tw-flex tw-items-center gap-2 px-2.5 py-1.5 tw-cursor-pointer tw-transition-colors tw-border-b last:tw-border-b-0 hover:tw-bg-opacity-50 tw-relative"
                style={{
                  color: 'var(--cui-body-color)',
                  backgroundColor: dropTargetDocId === doc.doc_id ? 'var(--cui-primary-bg)' : 'var(--cui-body-bg)',
                  borderColor: 'var(--cui-border-color)'
                }}
                onClick={() => onDocumentSelect(doc)}
                draggable={!!onLinkVersion}
                onDragStart={(event) => {
                  if (!onLinkVersion) return;
                  event.dataTransfer.setData('application/x-dms-doc', doc.doc_id);
                  event.dataTransfer.effectAllowed = 'move';
                }}
                onDragOver={(event) => {
                  if (!onLinkVersion) return;
                  if (!Array.from(event.dataTransfer.types).includes('application/x-dms-doc')) return;
                  event.preventDefault();
                  setDropTargetDocId(doc.doc_id);
                }}
                onDragLeave={() => {
                  if (!onLinkVersion) return;
                  if (dropTargetDocId === doc.doc_id) {
                    setDropTargetDocId(null);
                  }
                }}
                onDrop={(event) => {
                  if (!onLinkVersion) return;
                  event.preventDefault();
                  const sourceDocId = event.dataTransfer.getData('application/x-dms-doc');
                  setDropTargetDocId(null);
                  if (sourceDocId && sourceDocId !== doc.doc_id) {
                    onLinkVersion(sourceDocId, doc);
                  }
                }}
              >
                <input
                  type="checkbox"
                  className="h-4 w-4 rounded"
                  style={{ borderColor: 'var(--cui-border-color)' }}
                  checked={selectedDocIds?.has(doc.doc_id) ?? false}
                  onClick={(e) => e.stopPropagation()}
                  onChange={() => onToggleDocSelection?.(doc.doc_id)}
                />
                <span className="tw-text-lg" style={{ color: 'var(--cui-danger)' }}>ðŸ“„</span>
                <div className="tw-flex-1 tw-min-w-0" style={{ color: 'var(--cui-body-color)' }}>
                  <div className="tw-font-medium tw-truncate">
                    {doc.doc_name}
                  </div>
                  <div className="tw-text-sm" style={mutedTextStyle}>
                    V{doc.version_no || 1} â€¢ {doc.created_at ? new Date(doc.created_at).toLocaleDateString('en-US', {
                      month: '2-digit',
                      day: '2-digit',
                      year: 'numeric'
                    }) : 'No date'}
                  </div>
                </div>
                {/* Media badge chips â€” color-coded by media category */}
                {onReviewMedia && (
                  <MediaBadgeChips
                    mediaScanJson={doc.media_scan_json}
                    scanStatus={doc.media_scan_status}
                    compact={true}
                    onClick={() => onReviewMedia(parseInt(doc.doc_id, 10), doc.doc_name)}
                  />
                )}
                {dropTargetDocId === doc.doc_id && (
                  <span
                    className="tw-absolute right-2 top-1 text-[10px] tw-uppercase tw-tracking-wide"
                    style={{ color: 'var(--cui-primary)' }}
                  >
                    Link as Version
                  </span>
                )}
              </div>
            ))
          )}
        </div>
      )}

    </div>
  );
}

export default function AccordionFilters({
  filters,
  onExpand,
  onDocumentSelect,
  expandedFilter,
  selectedDocIds,
  onToggleDocSelection,
  onReviewMedia,
  onDeleteFilter,
  onLinkVersion
}: AccordionFiltersProps) {
  const renderedFilters = useMemo(() => filters, [filters]);

  return (
    <div className="tw-divide-y" style={{ borderColor: 'var(--cui-border-color)' }}>
      {renderedFilters.map((filter) => (
        <FilterDropRow
          key={filter.doc_type}
          filter={filter}
          expandedFilter={expandedFilter}
          onExpand={onExpand}
          onDocumentSelect={onDocumentSelect}
          selectedDocIds={selectedDocIds}
          onToggleDocSelection={onToggleDocSelection}
          onReviewMedia={onReviewMedia}
          onDeleteFilter={onDeleteFilter}
          onLinkVersion={onLinkVersion}
        />
      ))}
    </div>
  );
}
