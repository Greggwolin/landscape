'use client';

import React, { useState, useCallback, Fragment } from 'react';
import CIcon from '@coreui/icons-react';
import { cilCommentBubble, cilChevronBottom, cilChevronRight } from '@coreui/icons';
import type { PlatformKnowledgeDocument } from '@/types/dms';
import PlatformKnowledgeAccordion from './PlatformKnowledgeAccordion';
import ColumnChooser, { type ColumnConfig } from './ColumnChooser';

interface ChatMessage {
 role: 'user' | 'assistant';
 content: string;
 timestamp: Date;
}

interface PlatformKnowledgeTableProps {
 documents: PlatformKnowledgeDocument[];
 isLoading?: boolean;
}

const formatDateTime = (dateString: string | null | undefined) => {
 if (!dateString) return 'â€”';
 const date = new Date(dateString);
 return date.toLocaleString('en-US', {
 month: '2-digit',
 day: '2-digit',
 year: 'numeric',
 hour: '2-digit',
 minute: '2-digit'
 });
};

const DEFAULT_COLUMNS: ColumnConfig[] = [
 { id: 'title', label: 'Title', visible: true, required: true },
 { id: 'domain', label: 'Domain', visible: true },
 { id: 'source', label: 'Source', visible: true },
 { id: 'year', label: 'Year', visible: true },
 { id: 'scope', label: 'Scope', visible: true },
 { id: 'status', label: 'Status', visible: true },
 { id: 'updated', label: 'Updated', visible: false },
 { id: 'actions', label: 'Actions', visible: true, required: true }
];

const STORAGE_KEY = 'platform-knowledge-columns';

export default function PlatformKnowledgeTable({
 documents,
 isLoading = false
}: PlatformKnowledgeTableProps) {
 const [expandedDocKey, setExpandedDocKey] = useState<string | null>(null);
 const [chatHistories, setChatHistories] = useState<Record<string, ChatMessage[]>>({});
 const [columns, setColumns] = useState<ColumnConfig[]>(DEFAULT_COLUMNS);
 const [loadingChat, setLoadingChat] = useState(false);

 const visibleColumns = columns.filter(c => c.visible);
 const colSpan = visibleColumns.length;

 const handleRowClick = useCallback((docKey: string) => {
 setExpandedDocKey(prev => prev === docKey ? null : docKey);
 }, []);

 const handleSendMessage = useCallback(async (docKey: string, message: string) => {
 // Add user message immediately
 const userMessage: ChatMessage = {
 role: 'user',
 content: message,
 timestamp: new Date()
 };

 setChatHistories(prev => ({
 ...prev,
 [docKey]: [...(prev[docKey] || []), userMessage]
 }));

 setLoadingChat(true);

 try {
 const response = await fetch(`/api/platform-knowledge/${docKey}/chat`, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ message })
 });

 const data = await response.json();

 if (!response.ok) {
 throw new Error(data.error || 'Chat request failed');
 }

 const assistantMessage: ChatMessage = {
 role: 'assistant',
 content: data.content || data.response || data.answer || 'No response received',
 timestamp: new Date()
 };

 setChatHistories(prev => ({
 ...prev,
 [docKey]: [...(prev[docKey] || []), assistantMessage]
 }));
 } catch (error) {
 console.error('Chat error:', error);
 const errorMessage: ChatMessage = {
 role: 'assistant',
 content: `Error: ${error instanceof Error ? error.message : 'Failed to get response'}`,
 timestamp: new Date()
 };

 setChatHistories(prev => ({
 ...prev,
 [docKey]: [...(prev[docKey] || []), errorMessage]
 }));
 } finally {
 setLoadingChat(false);
 }
 }, []);

 const handleQuickAction = useCallback((docKey: string, action: 'summarize' | 'topics' | 'key_concepts' | 'methodologies') => {
 const prompts: Record<string, string> = {
 summarize: 'Please provide a concise summary of this document, highlighting the main points and key takeaways.',
 topics: 'What are the main topics, chapters, or sections covered in this document? Provide an overview of the structure and content areas.',
 key_concepts: 'What are the key concepts and terminology defined or explained in this document?',
 methodologies: 'What methodologies, frameworks, or approaches are described in this document?'
 };

 handleSendMessage(docKey, prompts[action]);
 }, [handleSendMessage]);

 const isColumnVisible = (colId: string) => columns.find(c => c.id === colId)?.visible ?? false;

 if (isLoading) {
 return (
 <div className="tw-flex tw-items-center tw-justify-center h-64">
 <div className="tw-animate-spin tw-rounded-full h-8 w-8 tw-border-b-2 tw-border-blue-600"></div>
 <span className="ml-3 text-body-secondary">Loading knowledge docs...</span>
 </div>
 );
 }

 if (documents.length === 0) {
 return (
 <div className="tw-flex tw-flex-col tw-items-center tw-justify-center h-64 text-body-tertiary">
 <span className="tw-text-4xl mb-3">ðŸ“˜</span>
 <p className="tw-text-sm">No platform knowledge documents found</p>
 </div>
 );
 }

 return (
 <div className="tw-flex tw-flex-col tw-h-full">
 {/* Toolbar */}
 <div className="tw-flex tw-items-center tw-justify-between px-3 py-2 tw-border-b border bg-body">
 <div className="tw-text-sm text-body-tertiary">
 {documents.length} document{documents.length !== 1 ? 's' : ''}
 </div>
 <ColumnChooser
 columns={columns}
 onChange={setColumns}
 storageKey={STORAGE_KEY}
 />
 </div>

 {/* Table */}
 <div className="tw-flex-1 tw-overflow-auto">
 <table className="tw-w-full">
 <thead className="bg-body-tertiary tw-sticky top-0 tw-z-10">
 <tr className="tw-border-b border">
 {isColumnVisible('title') && (
 <th className="px-3 py-2 text-left tw-text-sm tw-font-medium text-body-secondary">Title</th>
 )}
 {isColumnVisible('domain') && (
 <th className="px-3 py-2 text-left tw-text-sm tw-font-medium text-body-secondary">Domain</th>
 )}
 {isColumnVisible('source') && (
 <th className="px-3 py-2 text-left tw-text-sm tw-font-medium text-body-secondary">Source</th>
 )}
 {isColumnVisible('year') && (
 <th className="px-3 py-2 text-center tw-text-sm tw-font-medium text-body-secondary">Year</th>
 )}
 {isColumnVisible('scope') && (
 <th className="px-3 py-2 text-left tw-text-sm tw-font-medium text-body-secondary">Scope</th>
 )}
 {isColumnVisible('status') && (
 <th className="px-3 py-2 text-left tw-text-sm tw-font-medium text-body-secondary">Status</th>
 )}
 {isColumnVisible('updated') && (
 <th className="px-3 py-2 text-left tw-text-sm tw-font-medium text-body-secondary">Updated</th>
 )}
 {isColumnVisible('actions') && (
 <th className="px-3 py-2 text-right tw-text-sm tw-font-medium text-body-secondary">Actions</th>
 )}
 </tr>
 </thead>
 <tbody>
 {documents.map((doc) => {
 const isExpanded = expandedDocKey === doc.document_key;
 const canChat = doc.ingestion_status === 'indexed';

 return (
 <Fragment key={doc.document_key}>
 <tr
 onClick={() => canChat && handleRowClick(doc.document_key)}
 className={`tw-border-b border ${ canChat ? tw-'cursor-pointer' : tw-'cursor-default' } ${ isExpanded ? tw-'bg-blue-50 ' : canChat ? 'hover:bg-body-tertiary ' : '' }`}
 >
 {isColumnVisible('title') && (
 <td className="px-3 py-3">
 <div className="tw-flex tw-items-center gap-2">
 {canChat && (
 <span className="text-body-tertiary">
 <CIcon
 icon={isExpanded ? cilChevronBottom : cilChevronRight}
 className="w-4 h-4"
 />
 </span>
 )}
 <div>
 <div className="tw-font-medium text-body">{doc.title}</div>
 <div className="tw-text-xs text-body-tertiary">
 {doc.document_key}
 </div>
 </div>
 </div>
 </td>
 )}
 {isColumnVisible('domain') && (
 <td className="px-3 py-3 tw-text-sm text-body-secondary">
 {doc.knowledge_domain || 'â€”'}
 </td>
 )}
 {isColumnVisible('source') && (
 <td className="px-3 py-3 tw-text-sm text-body-secondary">
 {doc.publisher || 'â€”'}
 </td>
 )}
 {isColumnVisible('year') && (
 <td className="px-3 py-3 text-center tw-text-sm text-body-secondary">
 {doc.publication_year ?? 'â€”'}
 </td>
 )}
 {isColumnVisible('scope') && (
 <td className="px-3 py-3 tw-text-sm text-body-secondary">
 {doc.subtitle || 'â€”'}
 </td>
 )}
 {isColumnVisible('status') && (
 <td className="px-3 py-3 tw-text-sm">
 <span className={`tw-inline-flex tw-items-center px-2 py-0.5 rounded tw-text-xs tw-font-medium ${ doc.ingestion_status === 'indexed' ? tw-'bg-green-100 tw-text-green-800 ' : doc.ingestion_status === 'processing' ? tw-'bg-yellow-100 tw-text-yellow-800 ' : 'bg-body-secondary text-body-secondary ' }`}>
 {doc.ingestion_status || 'â€”'}
 </span>
 </td>
 )}
 {isColumnVisible('updated') && (
 <td className="px-3 py-3 tw-text-sm text-body-secondary">
 {formatDateTime(doc.updated_at)}
 </td>
 )}
 {isColumnVisible('actions') && (
 <td className="px-3 py-3 text-right">
 {canChat ? (
 <button
 type="button"
 onClick={(e) => {
 e.stopPropagation();
 handleRowClick(doc.document_key);
 }}
 className={`tw-inline-flex tw-items-center gap-1 px-2 py-1 tw-text-xs rounded ${ isExpanded ? tw-'bg-blue-600 text-white' : tw-'text-blue-600 hover:tw-bg-blue-50 ' }`}
 title={isExpanded ? 'Close chat' : 'Chat with this document'}
 >
 <CIcon icon={cilCommentBubble} className="w-3.5 h-3.5" />
 <span>{isExpanded ? 'Close' : 'Chat'}</span>
 </button>
 ) : (
 <span className="tw-text-xs text-body-tertiary">Not indexed</span>
 )}
 </td>
 )}
 </tr>

 {/* Accordion row */}
 {isExpanded && (
 <PlatformKnowledgeAccordion
 documentKey={doc.document_key}
 documentTitle={doc.title}
 pageCount={doc.page_count}
 chatHistory={chatHistories[doc.document_key] || []}
 onSendMessage={(message) => handleSendMessage(doc.document_key, message)}
 onQuickAction={(action) => handleQuickAction(doc.document_key, action)}
 isLoading={loadingChat}
 />
 )}
 </Fragment>
 );
 })}
 </tbody>
 </table>
 </div>
 </div>
 );
}
