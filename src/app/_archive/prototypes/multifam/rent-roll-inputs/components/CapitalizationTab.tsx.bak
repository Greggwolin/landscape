'use client';

import React, { useEffect, useMemo, useState } from 'react';
import LoanForm from './DebtFacilityForm';
import EquityPartnerForm from './EquityPartnerForm';
import WaterfallTierForm from './WaterfallTierForm';
import DrawScheduleForm from './DrawScheduleForm';

type Section = 'debt' | 'equity' | 'waterfall' | 'draws';

interface CapitalizationTabProps {
  projectId: number;
  mode: 'basic' | 'standard' | 'advanced';
}

interface LoanRecord {
  loan_id?: string | number;
  project_id?: number;
  loan_name: string;
  lender_name?: string;
  loan_amount: number;
  commitment_amount?: number;
  interest_rate_pct: number;
  loan_term_years: number;
  amortization_years?: number;
  is_construction_loan?: boolean;
  interest_type?: string;
  interest_spread_bps?: number;
  rate_floor_pct?: number;
  rate_cap_pct?: number;
  interest_index?: string;
  rate_reset_frequency?: string;
  loan_to_value_pct?: number;
  loan_covenant_dscr_min?: number;
  commitment_fee_pct?: number;
  extension_fee_bps?: number;
  prepayment_penalty_years?: number;
  exit_fee_pct?: number;
  guarantee_type?: string;
  guarantor_name?: string;
  loan_covenant_ltv_max?: number;
  loan_covenant_occupancy_min?: number;
  covenant_test_frequency?: string;
  reserve_requirements?: unknown;
  replacement_reserve_per_unit?: number;
  tax_insurance_escrow_months?: number;
  initial_reserve_months?: number;
  recourse_carveout_provisions?: string;
  commitment_balance?: number;
  drawn_to_date?: number;
  extension_options?: number;
  extension_option_years?: number;
  monthly_payment?: number;
  annual_debt_service?: number;
  created_at?: string;
  updated_at?: string;
}

interface EquityTranche {
  tranche_id?: number;
  tranche_name: string;
  partner_type: string;
  ownership_pct: number;
  capital_contributed: number;
  preferred_return_pct: number;
  unreturned_capital?: number;
  cumulative_distributions?: number;
  accrued_preferred_return?: number;
  preferred_return_paid_to_date?: number;
  promote_pct?: number;
  catch_up_pct?: number;
  promote_trigger_type?: string;
  promote_tier_1_threshold?: number;
  promote_tier_3_threshold?: number;
  promote_tier_3_pct?: number;
  irr_target_pct?: number;
  equity_multiple_target?: number;
  cash_on_cash_target_pct?: number;
  distribution_frequency?: string;
  distribution_priority?: number;
  can_defer_distributions?: boolean;
  management_fee_pct?: number;
  management_fee_base?: string;
  acquisition_fee_pct?: number;
  disposition_fee_pct?: number;
  promote_fee_pct?: number;
  has_clawback?: boolean;
  clawback_threshold_pct?: number;
  has_lookback?: boolean;
  lookback_at_sale?: boolean;
  notes?: string;
  created_at?: string;
  updated_at?: string;
}

interface WaterfallTier {
  tier_id?: number;
  project_id?: number;
  tier_number: number;
  tier_name: string;
  tier_description?: string;
  irr_threshold_pct?: number | null;
  equity_multiple_threshold?: number | null;
  lp_split_pct: number;
  gp_split_pct: number;
  is_pari_passu?: boolean;
  is_lookback_tier?: boolean;
  catch_up_to_pct?: number | null;
  has_catch_up?: boolean;
  is_active: boolean;
  display_order?: number;
  created_at?: string;
  updated_at?: string;
}

interface DrawScheduleItem {
  draw_id?: number;
  loan_id?: string | number;
  project_id?: number;
  period_id?: number | null;
  period_name: string;
  draw_number?: number;
  draw_amount: number;
  outstanding_balance?: number;
  draw_purpose: string;
  interest_rate_pct?: number;
  interest_expense?: number;
  interest_paid?: number;
  deferred_interest?: number;
  unused_fee_charge?: number;
  commitment_fee_charge?: number;
  other_fees?: number;
  draw_date: string;
  request_date?: string;
  approval_date?: string;
  funding_date?: string;
  inspector_approval?: boolean;
  lender_approval?: boolean;
  draw_status?: string;
  created_at?: string;
}

interface SummaryData {
  project_id: number;
  total_capitalization: number;
  total_debt: number;
  total_equity: number;
  leverage_ratio_pct: number;
  loans_count: number;
  equity_tranches_count: number;
  waterfall_tiers_count: number;
  waterfall_active_tiers_count?: number;
  weighted_avg_interest_rate: number;
  blended_ltv: number;
  preferred_return_pct: number;
  gp_promote_pct: number;
}

type ModalState =
  | { type: 'debt'; entity: LoanRecord | null }
  | { type: 'equity'; entity: EquityTranche | null }
  | { type: 'waterfall'; entity: WaterfallTier | null }
  | { type: 'draw'; entity: DrawScheduleItem | null }
  | null;

const SECTION_LABELS: Record<Section, string> = {
  debt: 'Loans',
  equity: 'Equity Structure',
  waterfall: 'Waterfall Tiers',
  draws: 'Draw Schedule',
};

export default function CapitalizationTab({ projectId, mode }: CapitalizationTabProps) {
  const [activeSection, setActiveSection] = useState<Section>('debt');
  const [loans, setLoans] = useState<LoanRecord[]>([]);
  const [equityTranches, setEquityTranches] = useState<EquityTranche[]>([]);
  const [waterfallTiers, setWaterfallTiers] = useState<WaterfallTier[]>([]);
  const [drawSchedule, setDrawSchedule] = useState<DrawScheduleItem[]>([]);
  const [drawSummary, setDrawSummary] = useState<{ total_commitment: number; total_drawn: number; remaining_capacity: number } | null>(null);
  const [summary, setSummary] = useState<SummaryData | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [modalState, setModalState] = useState<ModalState>(null);
  const [isModalSaving, setIsModalSaving] = useState(false);
  const [prototypeNotes, setPrototypeNotes] = useState('');
  const [showNotesModal, setShowNotesModal] = useState(false);
  const [isSavingNotes, setIsSavingNotes] = useState(false);
  const [notesMessage, setNotesMessage] = useState('');

  useEffect(() => {
    fetchAllData();
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [projectId]);

  useEffect(() => {
    const loadNotes = async () => {
      try {
        const response = await fetch('/api/prototypes/notes?prototypeId=multifam-capitalization');
        if (response.ok) {
          const notes = await response.json();
          if (Array.isArray(notes) && notes.length > 0) {
            setPrototypeNotes(notes[0].note);
          }
        }
      } catch (error) {
        console.error('Failed to load notes:', error);
      }
    };
    loadNotes();
  }, []);

  const loanOptions = useMemo(
    () =>
      loans
        .filter((loan): loan is LoanRecord & { loan_id: string | number } => loan.loan_id != null)
        .map((loan) => ({
          value: String(loan.loan_id),
          label: loan.loan_name,
        })),
    [loans]
  );

  const loanLookup = useMemo(() => {
    const map = new Map<string, LoanRecord>();
    loans.forEach((loan) => {
      if (loan.loan_id != null) {
        map.set(String(loan.loan_id), loan);
      }
    });
    return map;
  }, [loans]);

  const fetchAllData = async () => {
    try {
      setIsLoading(true);
      setSummary(null);
      setDrawSummary(null);

      const debtRes = await fetch(`/api/capitalization/debt?projectId=${projectId}`);
      const debtData = await debtRes.json();
      const loanData = Array.isArray(debtData)
        ? debtData
        : debtData?.data || debtData?.loans || debtData?.facilities || [];
      setLoans(loanData);

      const activeLoanId = loanData[0]?.loan_id != null ? String(loanData[0].loan_id) : null;

      const [equityRes, waterfallRes] = await Promise.all([
        fetch(`/api/capitalization/equity?projectId=${projectId}`),
        fetch(`/api/capitalization/waterfall?projectId=${projectId}`),
      ]);

      const [equityData, waterfallData] = await Promise.all([
        equityRes.json(),
        waterfallRes.json(),
      ]);

      if (equityData.success) setEquityTranches(equityData.data);
      if (waterfallData.success) setWaterfallTiers(waterfallData.data);

      if (activeLoanId) {
        const [summaryRes, drawsRes] = await Promise.all([
          fetch(`/api/capitalization/summary?projectId=${projectId}&loanId=${activeLoanId}`),
          fetch(`/api/capitalization/draws?projectId=${projectId}&loanId=${activeLoanId}`),
        ]);

        const [summaryData, drawsData] = await Promise.all([
          summaryRes.json(),
          drawsRes.json(),
        ]);

        if (summaryData?.success) {
          setSummary(summaryData.data);
        }
        if (Array.isArray(drawsData)) {
          setDrawSchedule(drawsData);
        } else if (drawsData?.success) {
          setDrawSchedule(drawsData.data);
          setDrawSummary(drawsData.summary ?? null);
        }
      } else {
        setDrawSchedule([]);
      }
    } catch (error) {
      console.error('Error fetching capitalization data:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const openLoanForm = (loan?: LoanRecord | null) => {
    setModalState({ type: 'debt', entity: loan ?? null });
  };

  const openEquityForm = (partner?: EquityTranche | null) => {
    setModalState({ type: 'equity', entity: partner ?? null });
  };

  const openWaterfallForm = (tier?: WaterfallTier | null) => {
    setModalState({ type: 'waterfall', entity: tier ?? null });
  };

  const openDrawForm = (draw?: DrawScheduleItem | null) => {
    setModalState({ type: 'draw', entity: draw ?? null });
  };

  const closeModal = () => {
    if (!isModalSaving) {
      setModalState(null);
    }
  };

  const handleLoanSave = async (formValues: LoanRecord) => {
    try {
      setIsModalSaving(true);
      const { loan_id, ...rest } = formValues;
      const isEdit = Boolean(loan_id);
      const response = await fetch(
        isEdit ? `/api/capitalization/debt/${loan_id}?projectId=${projectId}` : '/api/capitalization/debt',
        {
          method: isEdit ? 'PATCH' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(isEdit ? rest : { ...rest, project_id: projectId }),
        }
      );

      let payload: any = null;
      try {
        payload = await response.json();
      } catch (parseError) {
        // Non-JSON response, fall back to text message
        const text = await response.text().catch(() => '');
        if (text) {
          payload = { error: text };
        }
      }

      if (!response.ok || payload?.success === false) {
        console.error('Loan save failed', {
          status: response.status,
          payload,
        });
        const message =
          payload?.error ||
          payload?.message ||
          `Failed to ${isEdit ? 'update' : 'create'} loan (status ${response.status})`;
        throw new Error(message);
      }

      await fetchAllData();
      setModalState(null);
    } catch (error) {
      console.error('Error saving loan:', error);
      alert(error instanceof Error ? error.message : 'Failed to save loan');
    } finally {
      setIsModalSaving(false);
    }
  };

  const handleEquitySave = async (formValues: EquityTranche) => {
    try {
      setIsModalSaving(true);
      const { tranche_id, ...rest } = formValues;
      const isEdit = Boolean(tranche_id);
      const response = await fetch(
        isEdit ? `/api/capitalization/equity/${tranche_id}` : '/api/capitalization/equity',
        {
          method: isEdit ? 'PATCH' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(isEdit ? rest : { ...rest, project_id: projectId }),
        }
      );
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Failed to save equity partner');
      }
      await fetchAllData();
      setModalState(null);
    } catch (error) {
      console.error('Error saving equity partner:', error);
      alert(error instanceof Error ? error.message : 'Failed to save equity partner');
    } finally {
      setIsModalSaving(false);
    }
  };

  const handleWaterfallSave = async (formValues: WaterfallTier) => {
    try {
      setIsModalSaving(true);
      const { tier_id, ...rest } = formValues;
      const isEdit = Boolean(tier_id);
      const response = await fetch(
        isEdit ? `/api/capitalization/waterfall/${tier_id}` : '/api/capitalization/waterfall',
        {
          method: isEdit ? 'PATCH' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(isEdit ? rest : { ...rest, project_id: projectId }),
        }
      );
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Failed to save waterfall tier');
      }
      await fetchAllData();
      setModalState(null);
    } catch (error) {
      console.error('Error saving waterfall tier:', error);
      alert(error instanceof Error ? error.message : 'Failed to save waterfall tier');
    } finally {
      setIsModalSaving(false);
    }
  };

  const handleDrawSave = async (formValues: DrawScheduleItem) => {
    try {
      setIsModalSaving(true);
      const { draw_id, loan_id, ...rest } = formValues;
      const isEdit = Boolean(draw_id);
      if (!loan_id) {
        throw new Error('Select a loan for this draw schedule item.');
      }
      const payload = isEdit
        ? {
            draw_amount: rest.draw_amount,
            draw_date: rest.draw_date,
            draw_purpose: rest.draw_purpose,
            draw_status: rest.draw_status,
          }
        : {
            loan_id,
            project_id: projectId,
            draw_amount: rest.draw_amount,
            draw_date: rest.draw_date,
            draw_purpose: rest.draw_purpose,
            draw_status: rest.draw_status ?? 'PROJECTED',
            period_id: rest.period_id ?? null,
          };

      const response = await fetch(
        isEdit
          ? `/api/capitalization/draws/${draw_id}?projectId=${projectId}&loanId=${loan_id}`
          : '/api/capitalization/draws',
        {
          method: isEdit ? 'PATCH' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        }
      );
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Failed to save draw schedule item');
      }
      await fetchAllData();
      setModalState(null);
    } catch (error) {
      console.error('Error saving draw schedule item:', error);
      alert(error instanceof Error ? error.message : 'Failed to save draw schedule item');
    } finally {
      setIsModalSaving(false);
    }
  };

  const deleteLoan = async (loanId: string | number) => {
    if (!confirm('Delete this loan? Associated draw schedules will also be removed.')) {
      return;
    }
    try {
      const response = await fetch(`/api/capitalization/debt/${loanId}?projectId=${projectId}`, { method: 'DELETE' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Failed to delete loan');
      }
      await fetchAllData();
    } catch (error) {
      console.error('Error deleting loan:', error);
      alert(error instanceof Error ? error.message : 'Failed to delete loan');
    }
  };

  const deleteEquityTranche = async (trancheId: number) => {
    if (!confirm('Delete this equity partner?')) {
      return;
    }
    try {
      const response = await fetch(`/api/capitalization/equity/${trancheId}`, { method: 'DELETE' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Failed to delete equity partner');
      }
      await fetchAllData();
    } catch (error) {
      console.error('Error deleting equity partner:', error);
      alert(error instanceof Error ? error.message : 'Failed to delete equity partner');
    }
  };

  const deleteWaterfallTier = async (tierId: number) => {
    if (!confirm('Delete this waterfall tier?')) {
      return;
    }
    try {
      const response = await fetch(`/api/capitalization/waterfall/${tierId}`, { method: 'DELETE' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Failed to delete waterfall tier');
      }
      await fetchAllData();
    } catch (error) {
      console.error('Error deleting waterfall tier:', error);
      alert(error instanceof Error ? error.message : 'Failed to delete waterfall tier');
    }
  };

  const deleteDrawScheduleItem = async (drawId: number, loanId?: string | number) => {
    if (!confirm('Delete this draw schedule item?')) {
      return;
    }
    try {
      const response = await fetch(
        `/api/capitalization/draws/${drawId}?projectId=${projectId}&loanId=${loanId ?? ''}`,
        { method: 'DELETE' }
      );
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Failed to delete draw schedule item');
      }
      await fetchAllData();
    } catch (error) {
      console.error('Error deleting draw schedule item:', error);
      alert(error instanceof Error ? error.message : 'Failed to delete draw schedule item');
    }
  };

  const toggleWaterfallTier = async (tierId: number, isActive: boolean) => {
    try {
      const response = await fetch(`/api/capitalization/waterfall/${tierId}/toggle`, { method: 'PATCH' });
      const data = await response.json();
      if (!response.ok || data.success === false) {
        throw new Error(data.error || 'Failed to toggle tier');
      }
      setWaterfallTiers((prev) =>
        prev.map((tier) => (tier.tier_id === tierId ? { ...tier, is_active: !isActive } : tier))
      );
    } catch (error) {
      console.error('Error toggling waterfall tier:', error);
      alert(error instanceof Error ? error.message : 'Failed to toggle waterfall tier');
    }
  };

  const handleSaveNotes = async () => {
    setIsSavingNotes(true);
    setNotesMessage('');
    try {
      const response = await fetch('/api/prototypes/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prototypeId: 'multifam-capitalization',
          note: prototypeNotes,
        }),
      });
      if (response.ok) {
        setNotesMessage('Notes saved successfully.');
        setTimeout(() => setNotesMessage(''), 2500);
      } else {
        setNotesMessage('Failed to save notes');
      }
    } catch (error) {
      console.error('Failed to save notes:', error);
      setNotesMessage('Error saving notes');
    } finally {
      setIsSavingNotes(false);
    }
  };

  const formatCurrency = (value: number | null | undefined) => {
    if (value == null || Number.isNaN(value)) return '—';
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: 0,
    }).format(value);
  };

  const formatPercent = (value: number | null | undefined, digits = 2) => {
    if (value == null || Number.isNaN(value)) return '—';
    return `${value.toFixed(digits)}%`;
  };

  const handleAddDraw = () => {
    if (loans.length === 0) {
      alert('Add a loan before creating draw schedule items.');
      return;
    }
    const defaultLoanId = loanOptions[0]?.value;
    openDrawForm({
      loan_id: defaultLoanId,
      period_name: '',
      draw_amount: 0,
      draw_purpose: '',
      draw_date: new Date().toISOString().split('T')[0],
      draw_status: 'PROJECTED',
    });
  };

  if (isLoading) {
    return (
      <div className="p-8 tw-flex tw-items-center tw-justify-center">
        <div className="tw-text-gray-400">Loading capitalization data...</div>
      </div>
    );
  }

  const renderDebtSection = () => (
    <div>
      <div className="tw-flex tw-justify-between tw-items-center mb-4">
        <h3 className="tw-text-lg tw-font-semibold text-white">Loans</h3>
        <button
          onClick={() => openLoanForm()}
          className="px-4 py-2 tw-bg-blue-700 text-white tw-text-sm rounded hover:tw-bg-blue-600"
        >
          + Add Loan
        </button>
      </div>

      {loans.length === 0 ? (
        <div className="text-center py-8 tw-text-gray-400">No loans recorded yet.</div>
      ) : (
        <div className="tw-overflow-x-auto">
          <table className="tw-w-full tw-text-sm">
            <thead className="tw-bg-gray-900">
              <tr className="tw-border-b tw-border-gray-700">
                <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Loan</th>
                <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Lender</th>
                <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">Loan Amount</th>
                <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">Rate</th>
                <th className="text-center px-3 py-2 tw-font-medium tw-text-gray-300">Term</th>
                {mode !== 'basic' && (
                  <>
                    <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">LTV</th>
                    <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">DSCR</th>
                  </>
                )}
                <th className="text-center px-3 py-2 tw-font-medium tw-text-gray-300">Actions</th>
              </tr>
            </thead>
            <tbody>
              {loans.map((loan, idx) => (
                <tr
                  key={loan.loan_id ?? idx}
                  className={`tw-border-b tw-border-gray-700 ${idx % 2 === 0 ? tw-'bg-gray-800' : tw-'bg-gray-850'}`}
                >
                  <td className="px-3 py-3 align-top">
                    <div className="text-white tw-font-semibold">{loan.loan_name}</div>
                    <div className="tw-text-xs tw-text-gray-500 mt-1">
                      Created {loan.created_at ? new Date(loan.created_at).toLocaleDateString() : '—'}
                    </div>
                  </td>
                  <td className="px-3 py-3 align-top tw-text-gray-300">{loan.lender_name || '—'}</td>
                  <td className="px-3 py-3 align-top text-right text-white tw-font-medium">{formatCurrency(loan.loan_amount)}</td>
                  <td className="px-3 py-3 align-top text-right tw-text-gray-300">{formatPercent(loan.interest_rate_pct)}</td>
                  <td className="px-3 py-3 align-top text-center tw-text-gray-300">{loan.loan_term_years ?? '—'}</td>
                  {mode !== 'basic' && (
                    <>
                      <td className="px-3 py-3 align-top text-right tw-text-gray-300">{formatPercent(loan.loan_to_value_pct)}</td>
                      <td className="px-3 py-3 align-top text-right tw-text-gray-300">
                        {loan.loan_covenant_dscr_min != null ? loan.loan_covenant_dscr_min.toFixed(2) : '—'}
                      </td>
                    </>
                  )}
                  <td className="px-3 py-3 align-top text-center">
                    <div className="tw-flex tw-items-center tw-justify-center gap-2">
                      <button
                        onClick={() => openLoanForm(loan)}
                        className="px-3 py-1 tw-text-xs tw-bg-gray-700 tw-text-gray-200 rounded hover:tw-bg-gray-600 tw-transition-colors"
                      >
                        View / Edit
                      </button>
                      <button
                        onClick={() => {
                          if (!loan.loan_id) return;
                          deleteLoan(loan.loan_id);
                        }}
                        disabled={!loan.loan_id}
                        className="px-3 py-1 tw-text-xs tw-bg-red-900 tw-text-red-200 rounded hover:tw-bg-red-800 tw-transition-colors disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );

  const renderEquitySection = () => (
    <div>
      <div className="tw-flex tw-justify-between tw-items-center mb-4">
        <h3 className="tw-text-lg tw-font-semibold text-white">Equity Structure</h3>
        <button
          onClick={() => openEquityForm()}
          className="px-4 py-2 tw-bg-blue-700 text-white tw-text-sm rounded hover:tw-bg-blue-600"
        >
          + Add Partner
        </button>
      </div>

      {equityTranches.length === 0 ? (
        <div className="text-center py-8 tw-text-gray-400">No equity partners recorded yet.</div>
      ) : (
        <div className="tw-overflow-x-auto">
          <table className="tw-w-full tw-text-sm">
            <thead className="tw-bg-gray-900">
              <tr className="tw-border-b tw-border-gray-700">
                <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Partner</th>
                <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">Ownership</th>
                <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">Capital</th>
                <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">Pref Return</th>
                {mode !== 'basic' && (
                  <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Distribution Terms</th>
                )}
                {mode === 'advanced' && (
                  <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">Promote</th>
                )}
                <th className="text-center px-3 py-2 tw-font-medium tw-text-gray-300">Actions</th>
              </tr>
            </thead>
            <tbody>
              {equityTranches.map((tranche, idx) => (
                <tr
                  key={tranche.tranche_id ?? idx}
                  className={`tw-border-b tw-border-gray-700 ${idx % 2 === 0 ? tw-'bg-gray-800' : tw-'bg-gray-850'}`}
                >
                  <td className="px-3 py-3 align-top">
                    <div className="text-white tw-font-semibold">{tranche.tranche_name}</div>
                    <div className="tw-text-xs tw-text-gray-500 mt-1">{tranche.partner_type}</div>
                  </td>
                  <td className="px-3 py-3 align-top text-right tw-text-gray-300">{formatPercent(tranche.ownership_pct)}</td>
                  <td className="px-3 py-3 align-top text-right text-white tw-font-medium">{formatCurrency(tranche.capital_contributed)}</td>
                  <td className="px-3 py-3 align-top text-right tw-text-gray-300">{formatPercent(tranche.preferred_return_pct)}</td>
                  {mode !== 'basic' && (
                    <td className="px-3 py-3 align-top text-left tw-text-gray-300 tw-space-y-1">
                      <div>{tranche.distribution_frequency || 'Frequency: —'}</div>
                      {tranche.distribution_priority != null && (
                        <div className="tw-text-xs tw-text-gray-500">Priority {tranche.distribution_priority}</div>
                      )}
                      {tranche.can_defer_distributions && (
                        <div className="tw-text-xs tw-text-amber-300">Deferrable distributions enabled</div>
                      )}
                    </td>
                  )}
                  {mode === 'advanced' && (
                    <td className="px-3 py-3 align-top text-right tw-text-gray-300">{formatPercent(tranche.promote_pct)}</td>
                  )}
                  <td className="px-3 py-3 align-top text-center">
                    <div className="tw-flex tw-items-center tw-justify-center gap-2">
                      <button
                        onClick={() => openEquityForm(tranche)}
                        className="px-3 py-1 tw-text-xs tw-bg-gray-700 tw-text-gray-200 rounded hover:tw-bg-gray-600 tw-transition-colors"
                      >
                        View / Edit
                      </button>
                      <button
                        onClick={() => deleteEquityTranche(tranche.tranche_id ?? 0)}
                        className="px-3 py-1 tw-text-xs tw-bg-red-900 tw-text-red-200 rounded hover:tw-bg-red-800 tw-transition-colors"
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );

  const renderWaterfallSection = () => (
    <div>
      <div className="tw-flex tw-justify-between tw-items-center mb-4">
        <h3 className="tw-text-lg tw-font-semibold text-white">Waterfall Tiers</h3>
        <button
          onClick={() => openWaterfallForm()}
          className="px-4 py-2 tw-bg-blue-700 text-white tw-text-sm rounded hover:tw-bg-blue-600"
        >
          + Add Tier
        </button>
      </div>

      {waterfallTiers.length === 0 ? (
        <div className="text-center py-8 tw-text-gray-400">No waterfall tiers configured yet.</div>
      ) : (
        <div className="tw-overflow-x-auto">
          <table className="tw-w-full tw-text-sm">
            <thead className="tw-bg-gray-900">
              <tr className="tw-border-b tw-border-gray-700">
                <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Tier</th>
                {mode !== 'basic' && (
                  <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Threshold</th>
                )}
                <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">LP Split</th>
                <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">GP Split</th>
                {mode === 'advanced' && (
                  <th className="text-center px-3 py-2 tw-font-medium tw-text-gray-300">Catch-Up / Notes</th>
                )}
                <th className="text-center px-3 py-2 tw-font-medium tw-text-gray-300">Status</th>
                <th className="text-center px-3 py-2 tw-font-medium tw-text-gray-300">Actions</th>
              </tr>
            </thead>
            <tbody>
              {waterfallTiers.map((tier, idx) => (
                <tr
                  key={tier.tier_id ?? idx}
                  className={`tw-border-b tw-border-gray-700 ${idx % 2 === 0 ? tw-'bg-gray-800' : tw-'bg-gray-850'}`}
                >
                  <td className="px-3 py-3 align-top">
                    <div className="text-white tw-font-semibold">
                      Tier {tier.tier_number}: {tier.tier_name}
                    </div>
                    {tier.tier_description && (
                      <div className="tw-text-xs tw-text-gray-500 mt-1">{tier.tier_description}</div>
                    )}
                  </td>
                  {mode !== 'basic' && (
                    <td className="px-3 py-3 align-top text-left tw-text-gray-300 tw-space-y-1">
                      <div>IRR: {formatPercent(tier.irr_threshold_pct)}</div>
                      <div>
                        Equity Multiple:{' '}
                        {tier.equity_multiple_threshold != null ? tier.equity_multiple_threshold.toFixed(2) : '—'}
                      </div>
                    </td>
                  )}
                  <td className="px-3 py-3 align-top text-right tw-text-gray-300">{formatPercent(tier.lp_split_pct)}</td>
                  <td className="px-3 py-3 align-top text-right tw-text-gray-300">{formatPercent(tier.gp_split_pct)}</td>
                  {mode === 'advanced' && (
                    <td className="px-3 py-3 align-top text-center tw-text-gray-300 tw-space-y-1">
                      <div>{tier.is_pari_passu ? 'Pari Passu' : 'Promote Tier'}</div>
                      {tier.catch_up_to_pct != null && (
                        <div className="tw-text-xs tw-text-gray-500">Catch-up to {tier.catch_up_to_pct.toFixed(2)}%</div>
                      )}
                    </td>
                  )}
                  <td className="px-3 py-3 align-top text-center">
                    <span
                      className={`tw-inline-flex tw-items-center px-2 py-1 tw-rounded-full tw-text-xs tw-font-medium ${ tier.is_active ? tw-'bg-emerald-500/20 tw-text-emerald-300 border tw-border-emerald-500/40' : tw-'bg-slate-700 tw-text-slate-300 border tw-border-slate-500/40' }`}
                    >
                      {tier.is_active ? 'Active' : 'Inactive'}
                    </span>
                  </td>
                  <td className="px-3 py-3 align-top text-center">
                    <div className="tw-flex tw-items-center tw-justify-center gap-2">
                      <button
                        onClick={() => openWaterfallForm(tier)}
                        className="px-3 py-1 tw-text-xs tw-bg-gray-700 tw-text-gray-200 rounded hover:tw-bg-gray-600 tw-transition-colors"
                      >
                        View / Edit
                      </button>
                      <button
                        onClick={() => toggleWaterfallTier(tier.tier_id ?? 0, tier.is_active)}
                        className="px-3 py-1 tw-text-xs tw-bg-amber-900 tw-text-amber-200 rounded hover:tw-bg-amber-800 tw-transition-colors"
                      >
                        {tier.is_active ? 'Deactivate' : 'Activate'}
                      </button>
                      <button
                        onClick={() => deleteWaterfallTier(tier.tier_id ?? 0)}
                        className="px-3 py-1 tw-text-xs tw-bg-red-900 tw-text-red-200 rounded hover:tw-bg-red-800 tw-transition-colors"
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );

  const renderDrawSection = () => (
    <div>
      <div className="tw-flex tw-justify-between tw-items-center mb-4">
        <h3 className="tw-text-lg tw-font-semibold text-white">Construction Draw Schedule</h3>
        <button
          onClick={handleAddDraw}
          className="px-4 py-2 tw-bg-blue-700 text-white tw-text-sm rounded hover:tw-bg-blue-600"
        >
          + Add Draw
        </button>
      </div>

      {drawSummary && (
        <div className="tw-grid tw-grid-cols-1 md:tw-grid-cols-3 gap-3 mb-4">
          <div className="tw-bg-gray-800 border tw-border-gray-700 rounded p-4">
            <div className="tw-text-xs tw-text-gray-400 tw-uppercase">Total Commitment</div>
            <div className="tw-text-lg tw-font-semibold text-white">{formatCurrency(drawSummary.total_commitment)}</div>
          </div>
          <div className="tw-bg-gray-800 border tw-border-gray-700 rounded p-4">
            <div className="tw-text-xs tw-text-gray-400 tw-uppercase">Total Drawn</div>
            <div className="tw-text-lg tw-font-semibold text-white">{formatCurrency(drawSummary.total_drawn)}</div>
          </div>
          <div className="tw-bg-gray-800 border tw-border-gray-700 rounded p-4">
            <div className="tw-text-xs tw-text-gray-400 tw-uppercase">Remaining Capacity</div>
            <div className="tw-text-lg tw-font-semibold text-white">{formatCurrency(drawSummary.remaining_capacity)}</div>
          </div>
        </div>
      )}

      {drawSchedule.length === 0 ? (
        <div className="text-center py-8 tw-text-gray-400">No draw schedule items recorded yet.</div>
      ) : (
        <div className="tw-overflow-x-auto">
          <table className="tw-w-full tw-text-sm">
            <thead className="tw-bg-gray-900">
              <tr className="tw-border-b tw-border-gray-700">
                <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Period</th>
                <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Loan</th>
                <th className="text-right px-3 py-2 tw-font-medium tw-text-gray-300">Draw Amount</th>
                <th className="text-left px-3 py-2 tw-font-medium tw-text-gray-300">Purpose</th>
                <th className="text-center px-3 py-2 tw-font-medium tw-text-gray-300">Draw Date</th>
                <th className="text-center px-3 py-2 tw-font-medium tw-text-gray-300">Actions</th>
              </tr>
            </thead>
            <tbody>
              {drawSchedule.map((draw, idx) => {
                const loan = draw.loan_id ? loanLookup.get(String(draw.loan_id)) : undefined;
                return (
                  <tr
                    key={draw.draw_id ?? idx}
                    className={`tw-border-b tw-border-gray-700 ${idx % 2 === 0 ? tw-'bg-gray-800' : tw-'bg-gray-850'}`}
                  >
                    <td className="px-3 py-3 align-top text-white tw-font-medium">{draw.period_name || 'Unscheduled'}</td>
                    <td className="px-3 py-3 align-top tw-text-gray-300">{loan?.loan_name || '—'}</td>
                    <td className="px-3 py-3 align-top text-right text-white tw-font-medium">{formatCurrency(draw.draw_amount)}</td>
                    <td className="px-3 py-3 align-top tw-text-gray-300">{draw.draw_purpose || '—'}</td>
                    <td className="px-3 py-3 align-top text-center tw-text-gray-300">
                      {draw.draw_date ? new Date(draw.draw_date).toLocaleDateString() : '—'}
                    </td>
                    <td className="px-3 py-3 align-top text-center">
                      <div className="tw-flex tw-items-center tw-justify-center gap-2">
                        <button
                          onClick={() => openDrawForm(draw)}
                          className="px-3 py-1 tw-text-xs tw-bg-gray-700 tw-text-gray-200 rounded hover:tw-bg-gray-600 tw-transition-colors"
                        >
                          View / Edit
                        </button>
                        <button
                          onClick={() => deleteDrawScheduleItem(draw.draw_id ?? 0, draw.loan_id)}
                          className="px-3 py-1 tw-text-xs tw-bg-red-900 tw-text-red-200 rounded hover:tw-bg-red-800 tw-transition-colors"
                        >
                          Delete
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );

  return (
    <div className="p-4 tw-space-y-4 tw-bg-gray-950">
      <div className="tw-bg-gray-800 rounded border tw-border-gray-700 p-3 tw-flex tw-items-center tw-justify-between">
        <h2 className="tw-text-lg tw-font-semibold text-white">Capitalization - Prototype</h2>
        <button
          onClick={() => setShowNotesModal(true)}
          className={`px-3 py-2 text-white tw-text-sm rounded tw-transition-colors tw-flex tw-items-center gap-2 ${ prototypeNotes ? tw-'bg-blue-700 hover:tw-bg-blue-600' : tw-'bg-gray-700 hover:tw-bg-gray-600' }`}
        >
          {prototypeNotes ? 'Edit Notes' : 'Add Notes'}
        </button>
      </div>

      {summary && (
        <div className="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 lg:tw-grid-cols-4 gap-4">
          <div className="tw-bg-gray-800 rounded border tw-border-gray-700 p-4">
            <div className="tw-text-xs tw-text-gray-400 mb-1">Total Capitalization</div>
            <div className="tw-text-2xl tw-font-bold text-white">{formatCurrency(summary.total_capitalization)}</div>
            <div className="tw-text-xs tw-text-gray-500 mt-1">Debt + Equity</div>
          </div>
          <div className="tw-bg-gray-800 rounded border tw-border-gray-700 p-4">
            <div className="tw-text-xs tw-text-gray-400 mb-1">Total Debt</div>
            <div className="tw-text-2xl tw-font-bold text-white">{formatCurrency(summary.total_debt)}</div>
            <div className="tw-text-xs tw-text-gray-500 mt-1">{summary.loans_count} loans</div>
          </div>
          <div className="tw-bg-gray-800 rounded border tw-border-gray-700 p-4">
            <div className="tw-text-xs tw-text-gray-400 mb-1">Total Equity</div>
            <div className="tw-text-2xl tw-font-bold text-white">{formatCurrency(summary.total_equity)}</div>
            <div className="tw-text-xs tw-text-gray-500 mt-1">{summary.equity_tranches_count} partners</div>
          </div>
          <div className="tw-bg-gray-800 rounded border tw-border-gray-700 p-4">
            <div className="tw-text-xs tw-text-gray-400 mb-1">Leverage Ratio</div>
            <div className="tw-text-2xl tw-font-bold text-white">{formatPercent(summary.leverage_ratio_pct)}</div>
            <div className="tw-text-xs tw-text-gray-500 mt-1">Weighted rate {formatPercent(summary.weighted_avg_interest_rate, 3)}</div>
          </div>
        </div>
      )}

      <div className="tw-flex tw-flex-wrap tw-items-center gap-4 tw-border-b tw-border-gray-700 pb-2">
        {(['debt', 'equity', 'waterfall', 'draws'] as Section[]).map((section) => (
          <button
            key={section}
            onClick={() => setActiveSection(section)}
            className={`px-6 py-3 tw-text-sm tw-font-medium tw-transition-colors ${ activeSection === section ? 'text-white tw-border-b-2 border-white' : tw-'text-gray-400 hover:tw-text-gray-300' }`}
          >
            {SECTION_LABELS[section]} (
            {section === 'debt'
              ? loans.length
              : section === 'equity'
                ? equityTranches.length
                : section === 'waterfall'
                  ? waterfallTiers.length
                  : drawSchedule.length}
            )
          </button>
        ))}
      </div>

      <div className="p-4 tw-space-y-6">
        {activeSection === 'debt' && renderDebtSection()}
        {activeSection === 'equity' && renderEquitySection()}
        {activeSection === 'waterfall' && renderWaterfallSection()}
        {activeSection === 'draws' && renderDrawSection()}
      </div>

      {showNotesModal && (
        <div className="tw-fixed tw-inset-0 bg-black/70 tw-flex tw-items-center tw-justify-center tw-z-50 p-4" onClick={() => setShowNotesModal(false)}>
          <div className="tw-bg-gray-900 border tw-border-gray-700 tw-rounded-lg tw-max-w-2xl tw-w-full p-6" onClick={(e) => e.stopPropagation()}>
            <div className="tw-flex tw-items-center tw-justify-between mb-4">
              <h3 className="tw-text-lg tw-font-semibold text-white">Prototype Notes</h3>
              <button onClick={() => setShowNotesModal(false)} className="tw-text-gray-400 hover:text-white">
                ✕
              </button>
            </div>
            <textarea
              className="tw-w-full tw-min-h-[160px] tw-bg-gray-800 border tw-border-gray-700 rounded p-3 tw-text-sm tw-text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
              value={prototypeNotes}
              onChange={(e) => setPrototypeNotes(e.target.value)}
              placeholder="Capture quick reactions or follow-ups while reviewing this prototype."
            />
            {notesMessage && <div className="mt-2 tw-text-sm tw-text-emerald-400">{notesMessage}</div>}
            <div className="mt-6 tw-flex tw-justify-end gap-2">
              <button
                onClick={() => setShowNotesModal(false)}
                className="px-3 py-2 tw-text-sm tw-bg-gray-800 tw-text-gray-300 rounded hover:tw-bg-gray-700"
              >
                Close
              </button>
              <button
                onClick={handleSaveNotes}
                disabled={isSavingNotes}
                className="px-3 py-2 tw-text-sm tw-bg-blue-700 text-white rounded hover:tw-bg-blue-600 disabled:tw-opacity-50"
              >
                {isSavingNotes ? 'Saving…' : 'Save Notes'}
              </button>
            </div>
          </div>
        </div>
      )}

      {modalState?.type === 'debt' && (
        <LoanForm
          facility={modalState.entity}
          mode={mode}
          onSave={handleLoanSave}
          onCancel={closeModal}
          isSaving={isModalSaving}
        />
      )}

      {modalState?.type === 'equity' && (
        <EquityPartnerForm
          partner={modalState.entity}
          mode={mode}
          onSave={handleEquitySave}
          onCancel={closeModal}
          isSaving={isModalSaving}
        />
      )}

      {modalState?.type === 'waterfall' && (
        <WaterfallTierForm
          tier={modalState.entity}
          mode={mode}
          onSave={handleWaterfallSave}
          onCancel={closeModal}
          isSaving={isModalSaving}
        />
      )}

      {modalState?.type === 'draw' && (
        <DrawScheduleForm
          draw={modalState.entity}
          mode={mode}
          onSave={handleDrawSave}
          onCancel={closeModal}
          isSaving={isModalSaving}
          facilityOptions={loanOptions}
        />
      )}
    </div>
  );
}
