'use client'

import React, { useMemo, useState } from 'react'
import DropZone from './DropZone'
import type { Project, Area, Phase, Parcel } from './PlanningWizard'
import { useProjectConfig } from '@/hooks/useProjectConfig'
import { LandscapeButton } from '@/components/ui/landscape'

interface ProjectCanvasInlineProps {
  project: Project
  onAddArea: () => void
  onAddPhase: (areaId: string) => void
  onOpenPhase: (areaId: string, phaseId: string) => void
  onUpdateArea: (areaId: string, updates: { name: string; description: string }) => void
  onUpdatePhase: (areaId: string, phaseId: string, updates: { name: string; description: string }) => void
}

const getLandUseColor = (landUse?: string) => {
  if (!landUse) return 'bg-slate-600'
  switch (landUse) {
    case 'LDR':
    case 'SFD':
    case 'RES':
      return 'bg-emerald-600'
    case 'MDR':
    case 'MF':
      return 'bg-green-600'
    case 'HDR':
    case 'MHDR':
      return 'bg-teal-600'
    case 'C':
    case 'RET':
    case 'OFF':
      return 'bg-orange-600'
    case 'MU':
      return 'bg-amber-600'
    case 'OS':
      return 'bg-blue-600'
    default:
      return 'bg-slate-600'
  }
}

const getLandUseBorderColor = (landUse?: string) => {
  if (!landUse) return 'border-slate-500'
  switch (landUse) {
    case 'LDR':
    case 'SFD':
    case 'RES':
      return 'border-emerald-500'
    case 'MDR':
    case 'MF':
      return 'border-green-500'
    case 'HDR':
    case 'MHDR':
      return 'border-teal-500'
    case 'C':
    case 'RET':
    case 'OFF':
      return 'border-orange-500'
    case 'MU':
      return 'border-amber-500'
    case 'OS':
      return 'border-blue-500'
    default:
      return 'border-slate-500'
  }
}

const ProjectCanvasInline: React.FC<ProjectCanvasInlineProps> = ({
  project,
  onAddArea,
  onAddPhase,
  onOpenPhase,
  onUpdateArea,
  onUpdatePhase,
}) => {
  // Extract project ID from composite ID
  const projectIdFromId = (id: string): number | null => {
    const parts = id.split('-')
    const last = parts[parts.length - 1]
    const parsed = Number(last)
    return Number.isFinite(parsed) ? parsed : null
  }

  // Get dynamic labels for this project
  const projectId = projectIdFromId(project.id)
  const { labels } = useProjectConfig(projectId ?? undefined)

  const [editingArea, setEditingArea] = useState<string | null>(null)
  const [areaValues, setAreaValues] = useState<Record<string, { name: string; description: string }>>({})
  const [editingPhase, setEditingPhase] = useState<string | null>(null)
  const [phaseValues, setPhaseValues] = useState<Record<string, { areaId: string; name: string; description: string }>>({})

  const beginEditArea = (area: Area) => {
    setEditingArea(area.id)
    setAreaValues(prev => ({
      ...prev,
      [area.id]: {
        name: area.name,
        description: typeof (area as any).description === 'string' ? (area as any).description : '',
      },
    }))
  }

  const saveArea = (areaId: string) => {
    const values = areaValues[areaId]
    if (!values) return
    onUpdateArea(areaId, values)
    setEditingArea(null)
  }

  const cancelAreaEdit = () => {
    setEditingArea(null)
  }

  const beginEditPhase = (areaId: string, phase: Phase) => {
    setEditingPhase(phase.id)
    setPhaseValues(prev => ({
      ...prev,
      [phase.id]: {
        areaId,
        name: phase.name,
        description: typeof (phase as any).description === 'string' ? (phase as any).description : '',
      },
    }))
  }

  const savePhase = (phaseId: string) => {
    const values = phaseValues[phaseId]
    if (!values) return
    onUpdatePhase(values.areaId, phaseId, { name: values.name, description: values.description })
    setEditingPhase(null)
  }

  const cancelPhaseEdit = () => {
    setEditingPhase(null)
  }

  const dropHandlers = useMemo(() => {
    const map = new Map<string, (item: { type: string }) => void>()
    project.areas.forEach(area => {
      map.set(area.id, (item: { type: string }) => {
        if (item.type === 'phase') {
          onAddPhase(area.id)
        }
      })
    })
    return map
  }, [project.areas, onAddPhase])

  const renderParcelGrid = (phase: Phase) => (
    <div className="tw-grid tw-grid-cols-2 gap-2 mt-2">
      {phase.parcels.map((parcel: Parcel) => (
        <div
          key={parcel.id}
          className={`${getLandUseColor(parcel.usecode || parcel.landUse)} ${getLandUseBorderColor(parcel.usecode || parcel.landUse)} text-white rounded tw-text-xs p-2 border tw-transition-all tw-duration-200`}
        >
          <div className="tw-font-semibold tw-text-xs mb-1 tw-truncate">{parcel.name.replace('Parcel: ', '')}</div>
          <div className="tw-grid tw-grid-cols-[auto,1fr] tw-gap-x-2 tw-gap-y-1 text-left">
            <span className="tw-opacity-90">Use:</span>
            <span className="tw-font-medium tw-truncate">{parcel.usecode || parcel.landUse}</span>
            <span className="tw-opacity-90">Acres:</span>
            <span className="tw-font-medium">{parcel.acres ?? 0}</span>
            <span className="tw-opacity-90">Units:</span>
            <span className="tw-font-medium">{parcel.units ?? 0}</span>
            <span className="tw-opacity-90">Product:</span>
            <span className="tw-font-medium tw-truncate">{parcel.product || '-'}</span>
          </div>
        </div>
      ))}
      {phase.parcels.length === 0 && (
        <div className="tw-text-xs tw-text-gray-200 col-span-2 text-center italic">No {labels.level3LabelPlural.toLowerCase()}</div>
      )}
    </div>
  )

  return (
    <div className="tw-flex tw-flex-1 tw-flex-col gap-4 p-6 tw-bg-gray-950 tw-min-h-screen">
      <div className="tw-flex tw-items-center tw-justify-between">
        <h1 className="tw-text-lg tw-font-semibold text-white">{project.name}</h1>
        <LandscapeButton
          color="primary"
          size="sm"
          onClick={onAddArea}
        >
          Add {labels.level1Label}
        </LandscapeButton>
      </div>

      <div className="tw-grid tw-grid-cols-1 md:tw-grid-cols-2 xl:tw-grid-cols-3 gap-6">
        {project.areas.map(area => {
          const isEditing = editingArea === area.id
          const values = areaValues[area.id] ?? { name: area.name, description: (area as any).description ?? '' }
          const dropHandler = dropHandlers.get(area.id) ?? (() => {})
          return (
            <DropZone
              key={area.id}
              accepts={['phase']}
              onDrop={dropHandler}
              className="tw-min-h-[320px]"
            >
              <div className="tw-bg-gray-800 border tw-border-gray-700 tw-rounded-lg p-4 tw-h-full tw-flex tw-flex-col">
                <div className="tw-flex tw-items-start tw-justify-between mb-4">
                  {isEditing ? (
                    <div className="tw-flex-1 tw-space-y-2">
                      <input
                        value={values.name}
                        onChange={e => setAreaValues(prev => ({ ...prev, [area.id]: { ...values, name: e.target.value } }))}
                        className="tw-w-full tw-bg-gray-700 border tw-border-gray-600 rounded px-2 py-1 tw-text-sm text-white"
                      />
                      <textarea
                        value={values.description}
                        onChange={e => setAreaValues(prev => ({ ...prev, [area.id]: { ...values, description: e.target.value } }))}
                        className="tw-w-full tw-bg-gray-700 border tw-border-gray-600 rounded px-2 py-1 tw-text-xs text-white"
                        rows={2}
                        placeholder="Description"
                      />
                    </div>
                  ) : (
                    <div>
                      <h3 className="tw-text-sm tw-font-semibold text-white">{area.name}</h3>
                      {(area as any).description && (
                        <p className="tw-text-xs tw-text-gray-300 mt-1">{(area as any).description}</p>
                      )}
                    </div>
                  )}

                  <div className="tw-flex tw-flex-col gap-2 ml-3 tw-text-xs">
                    {isEditing ? (
                      <>
                        <LandscapeButton color="success" size="sm" onClick={() => saveArea(area.id)}>Save</LandscapeButton>
                        <LandscapeButton color="secondary" size="sm" onClick={cancelAreaEdit}>Cancel</LandscapeButton>
                      </>
                    ) : (
                      <>
                        <LandscapeButton color="secondary" size="sm" variant="outline" onClick={() => beginEditArea(area)}>Edit</LandscapeButton>
                        <LandscapeButton color="primary" size="sm" onClick={() => onAddPhase(area.id)}>Add {labels.level2Label}</LandscapeButton>
                      </>
                    )}
                  </div>
                </div>

                <div className="tw-space-y-3">
                  {area.phases.map(phase => {
                    const phaseEditing = editingPhase === phase.id
                    const phaseVals = phaseValues[phase.id] ?? {
                      areaId: area.id,
                      name: phase.name,
                      description: (phase as any).description ?? '',
                    }
                    return (
                      <div key={phase.id} className="tw-bg-gray-900 border tw-border-gray-700 rounded p-3">
                        <div className="tw-flex tw-items-start tw-justify-between">
                          {phaseEditing ? (
                            <div className="tw-flex-1 tw-space-y-2">
                              <input
                                value={phaseVals.name}
                                onChange={e => setPhaseValues(prev => ({ ...prev, [phase.id]: { ...phaseVals, name: e.target.value } }))}
                                className="tw-w-full tw-bg-gray-800 border tw-border-gray-600 rounded px-2 py-1 tw-text-xs text-white"
                              />
                              <textarea
                                value={phaseVals.description}
                                onChange={e => setPhaseValues(prev => ({ ...prev, [phase.id]: { ...phaseVals, description: e.target.value } }))}
                                className="tw-w-full tw-bg-gray-800 border tw-border-gray-600 rounded px-2 py-1 tw-text-xs text-white"
                                rows={2}
                                placeholder="Description"
                              />
                            </div>
                          ) : (
                            <div>
                              <div className="tw-text-xs tw-font-semibold text-white">{phase.name}</div>
                              {(phase as any).description && (
                                <p className="tw-text-xs tw-text-gray-300 mt-1">{(phase as any).description}</p>
                              )}
                            </div>
                          )}

                          <div className="tw-flex tw-flex-col gap-2 ml-3 text-[11px]">
                            {phaseEditing ? (
                              <>
                                <LandscapeButton color="success" size="sm" onClick={() => savePhase(phase.id)}>Save</LandscapeButton>
                                <LandscapeButton color="secondary" size="sm" onClick={cancelPhaseEdit}>Cancel</LandscapeButton>
                              </>
                            ) : (
                              <>
                                <LandscapeButton color="primary" size="sm" onClick={() => onOpenPhase(area.id, phase.id)}>Open</LandscapeButton>
                                <LandscapeButton color="secondary" size="sm" variant="outline" onClick={() => beginEditPhase(area.id, phase)}>Edit</LandscapeButton>
                              </>
                            )}
                          </div>
                        </div>

                        {renderParcelGrid(phase)}
                      </div>
                    )
                  })}

                  {area.phases.length === 0 && (
                    <div className="tw-text-xs tw-text-gray-300 italic">No {labels.level2LabelPlural.toLowerCase()} yet. Add one to get started.</div>
                  )}
                </div>
              </div>
            </DropZone>
          )
        })}
      </div>
    </div>
  )
}

export default ProjectCanvasInline
