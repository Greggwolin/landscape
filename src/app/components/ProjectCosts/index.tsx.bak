'use client'

import React from 'react'
import { formatNumber, parseNumber } from '../../lib/number'
import type { ProcessedUOMOptions } from '../../lib/uom-utils'

type CostItem = {
  id: number
  name: string
  amount: number | ''
  unit: string
  dvl: string
  enabled: boolean
}

type ProjectCostsState = {
  planningEngineering: CostItem[]
  development: CostItem[]
  ownership: CostItem[]
  carryCosts: CostItem[]
}

type Props = {
  projectCosts: ProjectCostsState
  updateProjectCost: (section: keyof ProjectCostsState, id: number, field: keyof CostItem, value: any) => void
  embedded?: boolean
  uomOptions?: ProcessedUOMOptions
}

const ProjectCosts: React.FC<Props> = ({ projectCosts, updateProjectCost, embedded = false, uomOptions }) => {
  const renderCostSection = (title: string, section: CostItem[], sectionKey: keyof ProjectCostsState) => (
    <div className="tw-overflow-hidden">
      <div className="tw-bg-slate-700 px-3 py-2 tw-border-b tw-border-slate-600">
        <h3 className="tw-text-sm tw-font-semibold text-white">{title}</h3>
        <div className="tw-flex tw-text-xs tw-text-gray-300 mt-1">
          <div className="tw-w-1/2">Item</div>
          <div className="tw-w-1/4 text-center">Amount</div>
          <div className="tw-w-1/4 text-center">Unit</div>
        </div>
      </div>
      <div className="p-2 tw-space-y-1">
        {section.filter(item => item.enabled || item.name).map(item => (
          <div key={item.id} className="tw-flex tw-items-center tw-text-xs tw-space-x-2">
            <div className="tw-w-1/2">
              <input
                type="text"
                className="tw-w-full tw-bg-gray-700 border tw-border-gray-600 rounded px-2 py-1 text-white tw-text-xs"
                placeholder="Item name"
                value={item.name}
                onChange={(e) => updateProjectCost(sectionKey, item.id, 'name', e.target.value)}
              />
            </div>
            <div className="tw-w-1/4">
              <input
                type="text"
                inputMode="decimal"
                className="tw-w-full tw-bg-gray-700 border tw-border-gray-600 rounded px-2 py-1 text-white tw-text-xs text-center"
                value={formatNumber(item.amount)}
                onChange={(e) => updateProjectCost(sectionKey, item.id, 'amount', parseNumber(e.target.value))}
              />
            </div>
            <div className="tw-w-1/4">
              <select
                className="tw-w-full tw-bg-gray-700 border tw-border-gray-600 rounded px-1 py-1 text-white tw-text-xs"
                value={item.unit}
                onChange={(e) => updateProjectCost(sectionKey, item.id, 'unit', e.target.value)}
              >
                {uomOptions?.all?.map((option, index) => {
                  if ('isDivider' in option) {
                    return (
                      <option key={`divider-${index}`} disabled style={{
                        borderTop: '1px solid #6b7280',
                        backgroundColor: '#374151',
                        fontSize: '0.7em',
                        fontStyle: 'italic',
                        color: '#9ca3af'
                      }}>
                        ────── Time-based ──────
                      </option>
                    );
                  }
                  return (
                    <option key={option.code} value={option.label}>{option.label}</option>
                  );
                }) ?? []}
              </select>
            </div>
          </div>
        ))}
      </div>
    </div>
  )

  return (
    <div className={`embedded ? tw-'space-y-4' : tw-'grid tw-grid-cols-1 lg:tw-grid-cols-2 gap-4'`}>
      {renderCostSection('Project Costs - Planning and Engineering', projectCosts.planningEngineering, 'planningEngineering')}
      {renderCostSection('Project Development Costs', projectCosts.development, 'development')}
      {renderCostSection('Ownership Cost', projectCosts.ownership, 'ownership')}
      {renderCostSection('Project Carry Cost Annual', projectCosts.carryCosts, 'carryCosts')}
    </div>
  )
}

export default ProjectCosts
