'use client'

import React, { useState, useEffect } from 'react'

interface MigrationStatus {
  total: number
  migrated: number
  pending: number
}

interface TaxonomyMappingSummary {
  family_name: string
  density_code: string
  type_code: string
  product_code?: string
  legacy_landuse_code: string
}

interface MigrationReport {
  totalParcels: number
  migratedParcels: number
  unmappedCodes: string[]
  errors: string[]
  mappings: Record<string, TaxonomyMappingSummary>
  message: string
}

const TaxonomyMigration: React.FC = () => {
  const [status, setStatus] = useState<MigrationStatus | null>(null)
  const [report, setReport] = useState<MigrationReport | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Load migration status on component mount
  useEffect(() => {
    loadStatus()
  }, [])

  const loadStatus = async () => {
    try {
      const response = await fetch('/api/landuse/migration?action=status')
      if (response.ok) {
        const data = await response.json()
        setStatus(data)
      } else {
        setError('Failed to load migration status')
      }
    } catch (err) {
      setError('Error loading migration status')
      console.error('Status load error:', err)
    }
  }

  const runAnalysis = async () => {
    setLoading(true)
    setError(null)
    setReport(null)

    try {
      const response = await fetch('/api/landuse/migration', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ dryRun: true })
      })

      if (response.ok) {
        const data = await response.json()
        setReport(data)
      } else {
        const errorData = await response.json()
        setError(errorData.error || 'Migration analysis failed')
      }
    } catch (err) {
      setError('Error running migration analysis')
      console.error('Analysis error:', err)
    } finally {
      setLoading(false)
    }
  }

  const runMigration = async () => {
    if (!confirm('Are you sure you want to run the migration? This will modify your database.')) {
      return
    }

    setLoading(true)
    setError(null)

    try {
      const response = await fetch('/api/landuse/migration', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ dryRun: false })
      })

      if (response.ok) {
        const data = await response.json()
        setReport(data)
        await loadStatus() // Refresh status after migration
      } else {
        const errorData = await response.json()
        setError(errorData.error || 'Migration failed')
      }
    } catch (err) {
      setError('Error running migration')
      console.error('Migration error:', err)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="tw-max-w-4xl mx-auto p-6 tw-space-y-6">
      <div className="bg-white border tw-border-gray-200 tw-rounded-lg tw-shadow-sm">
        <div className="tw-border-b tw-border-gray-200 px-6 py-4">
          <h2 className="tw-text-lg tw-font-semibold tw-text-gray-900">
            Land Use Taxonomy Migration
          </h2>
          <p className="tw-text-sm tw-text-gray-600 mt-1">
            Convert existing land use codes to the new four-field taxonomy system
          </p>
        </div>

        <div className="p-6">
          {/* Migration Status */}
          <div className="mb-6">
            <h3 className="text-md tw-font-medium tw-text-gray-900 mb-3">Current Status</h3>
            {status ? (
              <div className="tw-grid tw-grid-cols-3 gap-4">
                <div className="tw-bg-blue-50 border tw-border-blue-200 tw-rounded-lg p-4">
                  <div className="tw-text-2xl tw-font-bold tw-text-blue-900">{status.total}</div>
                  <div className="tw-text-sm tw-text-blue-700">Total Parcels</div>
                </div>
                <div className="tw-bg-green-50 border tw-border-green-200 tw-rounded-lg p-4">
                  <div className="tw-text-2xl tw-font-bold tw-text-green-900">{status.migrated}</div>
                  <div className="tw-text-sm tw-text-green-700">Migrated</div>
                </div>
                <div className="tw-bg-yellow-50 border tw-border-yellow-200 tw-rounded-lg p-4">
                  <div className="tw-text-2xl tw-font-bold tw-text-yellow-900">{status.pending}</div>
                  <div className="tw-text-sm tw-text-yellow-700">Pending</div>
                </div>
              </div>
            ) : (
              <div className="tw-text-gray-500">Loading status...</div>
            )}
          </div>

          {/* Actions */}
          <div className="mb-6">
            <h3 className="text-md tw-font-medium tw-text-gray-900 mb-3">Actions</h3>
            <div className="tw-flex gap-3">
              <button
                onClick={runAnalysis}
                disabled={loading}
                className="px-4 py-2 tw-bg-blue-600 text-white tw-rounded-md hover:tw-bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
              >
                {loading ? 'Analyzing...' : 'Run Analysis (Dry Run)'}
              </button>

              <button
                onClick={runMigration}
                disabled={loading || !report}
                className="px-4 py-2 tw-bg-green-600 text-white tw-rounded-md hover:tw-bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
              >
                {loading ? 'Migrating...' : 'Run Migration'}
              </button>

              <button
                onClick={loadStatus}
                disabled={loading}
                className="px-4 py-2 tw-bg-gray-600 text-white tw-rounded-md hover:tw-bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:tw-opacity-50 disabled:tw-cursor-not-allowed"
              >
                Refresh Status
              </button>
            </div>
          </div>

          {/* Error Display */}
          {error && (
            <div className="mb-6 p-4 tw-bg-red-50 border tw-border-red-200 tw-rounded-lg">
              <div className="tw-text-red-800 tw-font-medium">Error</div>
              <div className="tw-text-red-700 tw-text-sm mt-1">{error}</div>
            </div>
          )}

          {/* Migration Report */}
          {report && (
            <div className="tw-space-y-4">
              <h3 className="text-md tw-font-medium tw-text-gray-900">Migration Report</h3>

              <div className="tw-bg-gray-50 border tw-border-gray-200 tw-rounded-lg p-4">
                <div className="tw-text-sm tw-text-gray-700">{report.message}</div>
                <div className="mt-2 tw-text-xs tw-text-gray-600">
                  {report.totalParcels} total parcels, {report.migratedParcels} migrated
                </div>
              </div>

              {/* Unmapped Codes */}
              {report.unmappedCodes.length > 0 && (
                <div className="tw-bg-yellow-50 border tw-border-yellow-200 tw-rounded-lg p-4">
                  <div className="tw-text-yellow-800 tw-font-medium mb-2">
                    Unmapped Land Use Codes ({report.unmappedCodes.length})
                  </div>
                  <div className="tw-text-sm tw-text-yellow-700">
                    These codes do not have automatic mappings and will use default values:
                  </div>
                  <div className="mt-2 tw-flex tw-flex-wrap gap-2">
                    {report.unmappedCodes.map(code => (
                      <span key={code} className="px-2 py-1 tw-bg-yellow-200 tw-text-yellow-800 tw-text-xs rounded">
                        {code}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* Migration Mappings */}
              <div className="tw-bg-gray-50 border tw-border-gray-200 tw-rounded-lg p-4">
                <div className="tw-text-gray-800 tw-font-medium mb-2">Taxonomy Mappings</div>
                <div className="tw-space-y-2 tw-max-h-64 tw-overflow-y-auto">
                  {Object.entries(report.mappings).map(([code, mapping]) => (
                    <div key={code} className="tw-text-xs bg-white border tw-border-gray-200 rounded p-2">
                      <div className="tw-font-mono tw-font-medium">{code}</div>
                      <div className="tw-text-gray-600">
                        {mapping.family_name} → {mapping.density_code} → {mapping.type_code}
                        {mapping.product_code && ` → ${mapping.product_code}`}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Errors */}
              {report.errors.length > 0 && (
                <div className="tw-bg-red-50 border tw-border-red-200 tw-rounded-lg p-4">
                  <div className="tw-text-red-800 tw-font-medium mb-2">
                    Migration Errors ({report.errors.length})
                  </div>
                  <div className="tw-space-y-1">
                    {report.errors.map((error, index) => (
                      <div key={index} className="tw-text-sm tw-text-red-700">
                        {error}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  )
}

export default TaxonomyMigration
