/**
 * ComparablesGrid Component
 *
 * Displays all sales comparables in a horizontal table format
 * with Interactive AI Adjustments feature (3-column layout per comp)
 */

'use client';

import { useState, useCallback } from 'react';
import type { SalesComparable, AIAdjustmentSuggestion, SalesCompAdjustment } from '@/types/valuation';
import { AdjustmentCell } from './AdjustmentCell';
import { AdjustmentAnalysisPanel } from './AdjustmentAnalysisPanel';
import { acceptAISuggestion, updateUserAdjustment } from '@/lib/api/valuation';

interface ComparablesGridProps {
  comparables: SalesComparable[];
  projectId: number;
  onEdit?: (comp: SalesComparable) => void;
  onRefresh?: () => void;
}

interface OpenAnalysisPanel {
  comparableId: number;
  adjustmentType: string;
  suggestion: AIAdjustmentSuggestion;
  comparable: SalesComparable;
}

export function ComparablesGrid({ comparables, projectId, onEdit, onRefresh }: ComparablesGridProps) {
  const [openAdjustmentPanel, setOpenAdjustmentPanel] = useState<OpenAnalysisPanel | null>(null);

  const formatCurrency = (value: number | null | undefined) => {
    if (!value) return '-';
    return `$${value.toLocaleString()}`;
  };

  const formatDate = (dateString: string | null) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear().toString().slice(2)}`;
  };

  const formatPercent = (value: number | null | undefined) => {
    if (!value) return '-';
    return `${(value * 100).toFixed(2)}%`;
  };

  // Get AI suggestion for a specific comparable and adjustment type
  const getAISuggestion = (comp: SalesComparable, adjType: string): AIAdjustmentSuggestion | null => {
    return comp.ai_suggestions?.find(s => s.adjustment_type === adjType) || null;
  };

  // Get current adjustment for a specific comparable and adjustment type
  const getCurrentAdjustment = (comp: SalesComparable, adjType: string): SalesCompAdjustment | null => {
    return comp.adjustments?.find(a => a.adjustment_type === adjType) || null;
  };

  // Handle clicking the Ai button
  const handleAiClick = useCallback((compId: number, adjType: string, suggestion: AIAdjustmentSuggestion) => {
    const comparable = comparables.find(c => c.comparable_id === compId);
    if (!comparable) return;

    setOpenAdjustmentPanel({
      comparableId: compId,
      adjustmentType: adjType,
      suggestion,
      comparable
    });
  }, [comparables]);

  // Handle clicking the checkbox to accept AI suggestion
  const handleCheckboxClick = useCallback(async (compId: number, adjType: string, suggestedValue: number) => {
    try {
      const comparable = comparables.find(c => c.comparable_id === compId);
      const suggestion = comparable?.ai_suggestions?.find(s => s.adjustment_type === adjType);

      if (!suggestion) return;

      // Call API to accept the AI suggestion
      await acceptAISuggestion(suggestion.ai_suggestion_id);

      // Refresh data to show updated values
      onRefresh?.();
    } catch (error) {
      console.error('Failed to accept AI suggestion:', error);
    }
  }, [comparables, onRefresh]);

  // Handle manual changes to the Final column
  const handleFinalChange = useCallback(async (compId: number, adjType: string, value: number | null) => {
    try {
      const comparable = comparables.find(c => c.comparable_id === compId);
      const adjustment = comparable?.adjustments?.find(a => a.adjustment_type === adjType);

      if (!adjustment) {
        console.warn('No adjustment found to update');
        return;
      }

      // Update the user adjustment value
      await updateUserAdjustment(adjustment.adjustment_id, {
        user_adjustment_pct: value,
        ai_accepted: false // Manual override
      });

      // Refresh data
      onRefresh?.();
    } catch (error) {
      console.error('Failed to update user adjustment:', error);
    }
  }, [comparables, onRefresh]);

  // Handle accepting revised suggestion from analysis panel
  const handleAcceptRevised = useCallback(async (newValue: number) => {
    if (!openAdjustmentPanel) return;

    await handleFinalChange(
      openAdjustmentPanel.comparableId,
      openAdjustmentPanel.adjustmentType,
      newValue
    );
    setOpenAdjustmentPanel(null);
  }, [openAdjustmentPanel, handleFinalChange]);

  // Group adjustments by type
  const getAdjustmentsByType = () => {
    const types = new Set<string>();
    comparables.forEach(comp => {
      comp.adjustments?.forEach(adj => {
        types.add(adj.adjustment_type);
      });
      comp.ai_suggestions?.forEach(sug => {
        types.add(sug.adjustment_type);
      });
    });
    return Array.from(types);
  };

  const adjustmentTypes = getAdjustmentsByType();

  // If analysis panel is open, show it instead of the grid
  if (openAdjustmentPanel) {
    return (
      <AdjustmentAnalysisPanel
        comparable={openAdjustmentPanel.comparable}
        adjustmentType={openAdjustmentPanel.adjustmentType}
        aiSuggestion={openAdjustmentPanel.suggestion}
        onClose={() => setOpenAdjustmentPanel(null)}
        onAcceptRevised={handleAcceptRevised}
      />
    );
  }

  return (
    <div className="tw-space-y-4">
      {/* Main Grid */}
      <div
        className="tw-rounded-lg border tw-overflow-hidden"
        style={{
          backgroundColor: 'var(--cui-card-bg)',
          borderColor: 'var(--cui-border-color)'
        }}
      >
        <div className="tw-overflow-x-auto">
          <table className="tw-w-full tw-text-sm">
            <thead>
              {/* Main header row */}
              <tr
                className="tw-border-b"
                style={{
                  backgroundColor: 'var(--cui-tertiary-bg)',
                  borderColor: 'var(--cui-border-color)'
                }}
              >
                <th
                  className="text-left py-3 px-4 tw-font-semibold tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-body-color)',
                    minWidth: '150px',
                    backgroundColor: 'var(--cui-tertiary-bg)'
                  }}
                >
                  ID
                </th>
                {comparables.map((comp, idx) => (
                  <th
                    key={`comp-header-${comp.comparable_id}`}
                    colSpan={3}
                    className="text-center py-3 px-4 tw-font-semibold tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    Comp {idx + 1}
                  </th>
                ))}
              </tr>
              {/* Sub-header for Data | AI | Final columns */}
              <tr
                className="tw-border-b tw-text-xs"
                style={{
                  backgroundColor: 'var(--cui-tertiary-bg)',
                  borderColor: 'var(--cui-border-color)'
                }}
              >
                <th />
                {comparables.map(comp => (
                  <>
                    <th
                      key={`data-header-${comp.comparable_id}`}
                      className="py-2 px-2 tw-border-l"
                      style={{
                        color: 'var(--cui-secondary-color)',
                        borderColor: 'var(--cui-border-color)'
                      }}
                    >
                      Data
                    </th>
                    <th
                      key={`ai-header-${comp.comparable_id}`}
                      className="py-2 px-2 text-center"
                      style={{ color: 'var(--cui-secondary-color)' }}
                    >
                      AI
                    </th>
                    <th
                      key={`final-header-${comp.comparable_id}`}
                      className="py-2 px-2 text-center"
                      style={{ color: 'var(--cui-secondary-color)' }}
                    >
                      Final
                    </th>
                  </>
                ))}
              </tr>
            </thead>
            <tbody>
              {/* Address - property data rows span all 3 columns */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Address
                </td>
                {comparables.map(comp => (
                  <td
                    key={`addr-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      fontSize: '0.8125rem',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    <div className="tw-font-medium">{comp.property_name || 'Unnamed'}</div>
                    <div style={{ color: 'var(--cui-secondary-color)' }}>
                      {comp.address}
                      {comp.city && `, ${comp.city}, ${comp.state}`}
                    </div>
                  </td>
                ))}
              </tr>

              {/* Date */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Date
                </td>
                {comparables.map(comp => (
                  <td
                    key={`date-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {formatDate(comp.sale_date)}
                  </td>
                ))}
              </tr>

              {/* Sale Price */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Sale Price
                </td>
                {comparables.map(comp => (
                  <td
                    key={`price-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 tw-font-medium text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {comp.sale_price
                      ? `$${(Number(comp.sale_price) / 1000000).toFixed(2)}M`
                      : '-'}
                  </td>
                ))}
              </tr>

              {/* Price/Unit */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Price/Unit
                </td>
                {comparables.map(comp => (
                  <td
                    key={`ppu-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 tw-font-medium text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {formatCurrency(comp.price_per_unit ? Number(comp.price_per_unit) : null)}
                  </td>
                ))}
              </tr>

              {/* Price/SF */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Price/SF
                </td>
                {comparables.map(comp => (
                  <td
                    key={`psf-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 tw-font-medium text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {comp.price_per_sf ? `$${Number(comp.price_per_sf).toLocaleString()}` : '-'}
                  </td>
                ))}
              </tr>

              {/* Units */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Units
                </td>
                {comparables.map(comp => (
                  <td
                    key={`units-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {comp.units || '-'}
                  </td>
                ))}
              </tr>

              {/* Building SF */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Building SF
                </td>
                {comparables.map(comp => (
                  <td
                    key={`bsf-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {comp.building_sf ? Number(comp.building_sf).toLocaleString() : '-'}
                  </td>
                ))}
              </tr>

              {/* Cap Rate */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Cap Rate
                </td>
                {comparables.map(comp => (
                  <td
                    key={`cap-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {comp.cap_rate ? `${(Number(comp.cap_rate) * 100).toFixed(2)}%` : '-'}
                  </td>
                ))}
              </tr>

              {/* Year Built */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Year Built
                </td>
                {comparables.map(comp => (
                  <td
                    key={`year-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {comp.year_built || '-'}
                  </td>
                ))}
              </tr>

              {/* Distance */}
              <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                <td
                  className="py-2 px-4 tw-font-medium tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-secondary-color)',
                    backgroundColor: 'var(--cui-card-bg)'
                  }}
                >
                  Distance
                </td>
                {comparables.map(comp => (
                  <td
                    key={`dist-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 text-left tw-border-l"
                    style={{
                      color: 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {comp.distance_from_subject || '-'}
                  </td>
                ))}
              </tr>

              {/* Adjustments Sub-header: Adjustments | AI | Final */}
              {adjustmentTypes.length > 0 && (
                <tr
                  className="tw-border-b"
                  style={{
                    backgroundColor: 'var(--cui-tertiary-bg)',
                    borderColor: 'var(--cui-border-color)'
                  }}
                >
                  <td
                    className="py-2 px-4 tw-font-semibold tw-sticky left-0 tw-z-10"
                    style={{
                      color: 'var(--cui-body-color)',
                      backgroundColor: 'var(--cui-tertiary-bg)'
                    }}
                  >
                    Adjustments
                  </td>
                  {comparables.map(comp => (
                    <>
                      <th
                        key={`adj-col-${comp.comparable_id}`}
                        className="py-2 px-2 tw-text-xs tw-font-normal tw-border-l"
                        style={{
                          color: 'var(--cui-secondary-color)',
                          borderColor: 'var(--cui-border-color)'
                        }}
                      >
                        AI
                      </th>
                      <th
                        key={`final-col-${comp.comparable_id}`}
                        className="py-2 px-2 tw-text-xs tw-font-normal text-center"
                        colSpan={2}
                        style={{
                          color: 'var(--cui-secondary-color)'
                        }}
                      >
                        Final
                      </th>
                    </>
                  ))}
                </tr>
              )}

              {/* Transaction Section Header */}
              {adjustmentTypes.length > 0 && (
                <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                  <td
                    className="py-2 px-4 tw-font-semibold tw-sticky left-0 tw-z-10"
                    style={{
                      color: 'var(--cui-body-color)',
                      backgroundColor: 'var(--cui-card-bg)'
                    }}
                  >
                    Transaction
                  </td>
                  {comparables.map(comp => (
                    <td
                      key={`trans-header-${comp.comparable_id}`}
                      colSpan={3}
                      className="tw-border-l"
                      style={{ borderColor: 'var(--cui-border-color)' }}
                    />
                  ))}
                </tr>
              )}

              {/* Market Conditions - adjustment rows use AdjustmentCell */}
              {adjustmentTypes.includes('market_conditions') && (
                <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                  <td
                    className="py-2 px-4 pl-8 tw-sticky left-0 tw-z-10"
                    style={{
                      color: 'var(--cui-secondary-color)',
                      backgroundColor: 'var(--cui-card-bg)'
                    }}
                  >
                    Market Conditions
                  </td>
                  {comparables.map(comp => (
                    <>
                      <td
                        key={`mc-data-${comp.comparable_id}`}
                        className="py-2 px-2 text-center tw-border-l"
                        style={{
                          color: 'var(--cui-secondary-color)',
                          borderColor: 'var(--cui-border-color)'
                        }}
                      >
                        -
                      </td>
                      <AdjustmentCell
                        key={`mc-cell-${comp.comparable_id}`}
                        comparableId={comp.comparable_id}
                        adjustmentType="market_conditions"
                        aiSuggestion={getAISuggestion(comp, 'market_conditions')}
                        currentAdjustment={getCurrentAdjustment(comp, 'market_conditions')}
                        onAiClick={handleAiClick}
                        onCheckboxClick={handleCheckboxClick}
                        onFinalChange={handleFinalChange}
                      />
                    </>
                  ))}
                </tr>
              )}

              {/* Location */}
              {adjustmentTypes.includes('location') && (
                <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                  <td
                    className="py-2 px-4 pl-8 tw-sticky left-0 tw-z-10"
                    style={{
                      color: 'var(--cui-secondary-color)',
                      backgroundColor: 'var(--cui-card-bg)'
                    }}
                  >
                    Location
                  </td>
                  {comparables.map(comp => (
                    <>
                      <td
                        key={`loc-data-${comp.comparable_id}`}
                        className="py-2 px-2 text-center tw-border-l"
                        style={{
                          color: 'var(--cui-secondary-color)',
                          borderColor: 'var(--cui-border-color)'
                        }}
                      >
                        -
                      </td>
                      <AdjustmentCell
                        key={`loc-cell-${comp.comparable_id}`}
                        comparableId={comp.comparable_id}
                        adjustmentType="location"
                        aiSuggestion={getAISuggestion(comp, 'location')}
                        currentAdjustment={getCurrentAdjustment(comp, 'location')}
                        onAiClick={handleAiClick}
                        onCheckboxClick={handleCheckboxClick}
                        onFinalChange={handleFinalChange}
                      />
                    </>
                  ))}
                </tr>
              )}

              {/* Physical - Age */}
              {adjustmentTypes.includes('physical_age') && (
                <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                  <td
                    className="py-2 px-4 pl-8 tw-sticky left-0 tw-z-10"
                    style={{
                      color: 'var(--cui-secondary-color)',
                      backgroundColor: 'var(--cui-card-bg)'
                    }}
                  >
                    Physical - Age
                  </td>
                  {comparables.map(comp => (
                    <>
                      <td
                        key={`age-data-${comp.comparable_id}`}
                        className="py-2 px-2 text-center tw-border-l"
                        style={{
                          color: 'var(--cui-secondary-color)',
                          borderColor: 'var(--cui-border-color)'
                        }}
                      >
                        -
                      </td>
                      <AdjustmentCell
                        key={`age-cell-${comp.comparable_id}`}
                        comparableId={comp.comparable_id}
                        adjustmentType="physical_age"
                        aiSuggestion={getAISuggestion(comp, 'physical_age')}
                        currentAdjustment={getCurrentAdjustment(comp, 'physical_age')}
                        onAiClick={handleAiClick}
                        onCheckboxClick={handleCheckboxClick}
                        onFinalChange={handleFinalChange}
                      />
                    </>
                  ))}
                </tr>
              )}

              {/* Physical - Condition */}
              {adjustmentTypes.includes('physical_condition') && (
                <tr className="tw-border-b" style={{ borderColor: 'var(--cui-border-color)' }}>
                  <td
                    className="py-2 px-4 pl-8 tw-sticky left-0 tw-z-10"
                    style={{
                      color: 'var(--cui-secondary-color)',
                      backgroundColor: 'var(--cui-card-bg)'
                    }}
                  >
                    Physical - Condition
                  </td>
                  {comparables.map(comp => (
                    <>
                      <td
                        key={`cond-data-${comp.comparable_id}`}
                        className="py-2 px-2 text-center tw-border-l"
                        style={{
                          color: 'var(--cui-secondary-color)',
                          borderColor: 'var(--cui-border-color)'
                        }}
                      >
                        -
                      </td>
                      <AdjustmentCell
                        key={`cond-cell-${comp.comparable_id}`}
                        comparableId={comp.comparable_id}
                        adjustmentType="physical_condition"
                        aiSuggestion={getAISuggestion(comp, 'physical_condition')}
                        currentAdjustment={getCurrentAdjustment(comp, 'physical_condition')}
                        onAiClick={handleAiClick}
                        onCheckboxClick={handleCheckboxClick}
                        onFinalChange={handleFinalChange}
                      />
                    </>
                  ))}
                </tr>
              )}

              {/* Total Adjustments */}
              <tr
                className="tw-border-b"
                style={{
                  borderColor: 'var(--cui-border-color)',
                  backgroundColor: 'var(--cui-tertiary-bg)'
                }}
              >
                <td
                  className="py-2 px-4 tw-font-semibold tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-body-color)',
                    backgroundColor: 'var(--cui-tertiary-bg)'
                  }}
                >
                  Total Adjustments
                </td>
                {comparables.map(comp => (
                  <td
                    key={`total-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-2 px-4 tw-font-bold text-right tw-border-l"
                    style={{
                      color: comp.total_adjustment_pct > 0
                        ? 'var(--cui-success)'
                        : comp.total_adjustment_pct < 0
                        ? 'var(--cui-danger)'
                        : 'var(--cui-body-color)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {comp.total_adjustment_pct > 0 ? '+' : ''}
                    {(comp.total_adjustment_pct * 100).toFixed(0)}%
                  </td>
                ))}
              </tr>

              {/* Adjusted Price/Unit */}
              <tr style={{ backgroundColor: 'var(--surface-subheader)' }}>
                <td
                  className="py-3 px-4 tw-font-semibold tw-sticky left-0 tw-z-10"
                  style={{
                    color: 'var(--cui-body-color)',
                    backgroundColor: 'var(--cui-tertiary-bg)'
                  }}
                >
                  Adjusted Price/Unit
                </td>
                {comparables.map(comp => (
                  <td
                    key={`adj-price-${comp.comparable_id}`}
                    colSpan={3}
                    className="py-3 px-4 tw-font-bold tw-text-base text-right tw-border-l"
                    style={{
                      color: 'var(--cui-primary)',
                      borderColor: 'var(--cui-border-color)'
                    }}
                  >
                    {formatCurrency(comp.adjusted_price_per_unit ? Number(comp.adjusted_price_per_unit) : null)}
                  </td>
                ))}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
